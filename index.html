<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂçÉ‰ª£Áî∞Âå∫„Ç≥„É°„É≥„Éà„Éû„ÉÉ„Éó</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        body { margin: 0; padding: 0; overflow: hidden; font-family: "Helvetica Neue", Arial, sans-serif; color: #333; background: #fff; }
        #container { display: flex; height: 100vh; width: 100vw; flex-direction: row; }

        /* --- „Çµ„Ç§„Éâ„Éê„Éº --- */
        #sidebar {
            width: 340px; background-color: #fff; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; z-index: 2000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05); position: relative;
        }
        #mapid { flex: 1; height: 100%; background-color: #fff; position: relative; }

        /* ‚òÖ‰øÆÊ≠£‚òÖ „Çπ„Éû„ÉõÁî®„É¨„Çπ„Éù„É≥„Ç∑„Éñ (50:50) */
        @media (max-width: 600px) {
            #container { flex-direction: column; }
            #mapid { height: 50%; width: 100%; order: 1; }
            #sidebar { width: 100%; height: 50%; border-right: none; border-top: 1px solid #ddd; order: 2; }
            #sidebar-toggle { display: none; }
        }

        /* --- Âú∞Âõ≥‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Éá„Ç∂„Ç§„É≥ --- */
        .marker-container {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            position: relative; overflow: visible; width: 120px;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
            cursor: pointer; /* „ÇØ„É™„ÉÉ„ÇØ„Åß„Åç„ÇãÊÑü */
        }

        .marker-bubble {
            background-color: #fff; border-radius: 20px; padding: 6px 12px;
            font-size: 12px; font-weight: bold; color: #444; white-space: nowrap;
            margin-bottom: 8px; max-width: 150px; overflow: visible !important;
            text-overflow: ellipsis; position: relative; text-align: center; border: 1px solid #eee;
        }
        .marker-content { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        
        .marker-bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
            border-width: 6px 6px 0; border-style: solid;
            border-color: #fff transparent transparent transparent; display: block; z-index: 1;
        }

        .marker-circle {
            border-radius: 50%; background-size: cover; background-position: center;
            transition: all 0.2s ease; position: relative; z-index: 2;
        }
        .marker-circle.has-image { width: 40px; height: 40px; border: 3px solid white; background-color: #fff; }
        .marker-circle.no-image { width: 18px; height: 18px; border: 2px solid white; }

        /* „Ç´„ÉÜ„Ç¥„É™Ëâ≤ */
        .category-gourmet .marker-circle.no-image { background-color: #ff9800; }
        .category-view .marker-circle.no-image { background-color: #4caf50; }
        .category-event .marker-circle.no-image { background-color: #9c27b0; }
        .category-other .marker-circle.no-image { background-color: #007bff; }

        .category-gourmet .marker-bubble { border-bottom: 2px solid #ff9800; }
        .category-view .marker-bubble { border-bottom: 2px solid #4caf50; }
        .category-event .marker-bubble { border-bottom: 2px solid #9c27b0; }
        .category-other .marker-bubble { border-bottom: 2px solid #007bff; }

        .highlight-pin .marker-circle { transform: scale(1.2); border-color: #ff4081; }
        .highlight-pin .marker-bubble { color: #007bff; transform: scale(1.05); }
        .highlight-pin { z-index: 10000 !important; }

        /* --- UI„Éë„Éº„ÉÑ --- */
        #sidebar-toggle {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background-color: white; border: 1px solid #ddd; color: #555;
            border-radius: 4px; padding: 5px 10px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #gps-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            background-color: white; border: none; border-radius: 50%;
            width: 44px; height: 44px; cursor: pointer; color: #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: background 0.2s;
        }
        #gps-btn:active { background: #f0f0f0; }

        #login-section { padding: 15px; background-color: #fff; border-bottom: 1px solid #eee; }
        #user-info { display: none; align-items: center; gap: 10px; }
        .user-icon-wrapper { position: relative; cursor: pointer; }
        #user-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .icon-edit-overlay { position: absolute; bottom: 0; right: -5px; background: #007bff; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        #user-details { flex: 1; overflow: hidden; }
        #user-name { font-weight: bold; font-size: 14px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .edit-btn { background: none; border: none; color: #007bff; font-size: 11px; cursor: pointer; padding: 0; }
        .auth-btn { width: 100%; padding: 8px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-login { background-color: #4285f4; color: white; }
        .btn-logout { background-color: #f0f0f0; color: #555; width: auto; font-size: 11px; padding: 4px 8px; }

        #filter-section { padding: 10px 15px; border-bottom: 1px solid #eee; background: #fcfcfc; display: flex; gap: 10px; align-items: center; }
        .sort-select { padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: #fff; flex: 1; }
        #sidebar-content { flex: 1; overflow-y: auto; padding: 0; scroll-behavior: smooth; }

        #comment-list { list-style: none; padding: 0; margin: 0; }
        .comment-item { display: flex; align-items: flex-start; padding: 12px 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .comment-item:hover { background-color: #fafafa; }
        .comment-item.active { background-color: #f0f8ff; border-left-color: #007bff; }
        
        .comment-item.cat-gourmet { border-left-color: #ff9800; }
        .comment-item.cat-view { border-left-color: #4caf50; }
        .comment-item.cat-event { border-left-color: #9c27b0; }
        
        .item-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; object-fit: cover; background: #eee; flex-shrink: 0; }
        .item-body { flex: 1; min-width: 0; margin-right: 10px; }
        .item-header { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .item-author { font-weight: bold; font-size: 13px; color: #333; }
        .item-time { font-size: 11px; color: #999; }
        .item-text { font-size: 13px; color: #444; line-height: 1.4; word-wrap: break-word; }
        .item-footer { display: flex; align-items: center; gap: 12px; margin-top: 6px; }
        
        .item-btn { background: none; border: none; cursor: pointer; color: #ccc; font-size: 13px; padding: 2px; display: flex; align-items: center; gap: 4px; transition: color 0.2s; }
        .item-btn:hover { color: #555; }
        
        .item-like-btn.liked { color: #ff4081; }
        .item-like-btn:hover { color: #ff4081; }
        .item-share-btn:hover { color: #007bff; }
        
        .item-delete-btn { color: #ccc; display: none; }
        .item-delete-btn:hover { color: #ff4444; }
        .my-post .item-delete-btn { display: inline-block; }
        
        .item-right-img { width: 60px; height: 60px; border-radius: 6px; object-fit: cover; border: 1px solid #eee; background: #f9f9f9; flex-shrink: 0; }
        
        .hashtag { color: #007bff; margin-right: 2px; }
        .comment-form { text-align: center; width: 240px; padding: 5px; }
        .form-header { font-size: 12px; color: #666; margin-bottom: 8px; text-align: left; }
        .comment-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .category-selector { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .cat-radio { display: none; }
        .cat-label { font-size: 20px; padding: 5px 10px; cursor: pointer; border-radius: 50%; border: 2px solid transparent; transition: all 0.2s; opacity: 0.6; grayscale: 100%; }
        .cat-label:hover { opacity: 1; }
        .cat-radio:checked + .cat-label { opacity: 1; transform: scale(1.2); border-color: #007bff; background: #eef6ff; }
        #cat-gourmet:checked + .cat-label { border-color: #ff9800; background: #fff3e0; }
        #cat-view:checked + .cat-label { border-color: #4caf50; background: #e8f5e9; }
        #cat-event:checked + .cat-label { border-color: #9c27b0; background: #f3e5f5; }
        .form-actions { display: flex; justify-content: space-between; align-items: center; }
        .image-upload-label { cursor: pointer; color: #007bff; font-size: 20px; padding: 5px; transition: color 0.2s; }
        .image-upload-label.has-file { color: #28a745; }
        #post-file-input, #avatar-upload-input { display: none; }
        .comment-btn { padding: 8px 20px; background: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.success { background-color: #28a745; }
        #toast.error { background-color: #dc3545; }
    </style>
</head>
<body>

    <div id="container">
        <div id="sidebar">
            <div id="login-section">
                <button id="login-btn" class="auth-btn btn-login">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                <div id="user-info">
                    <label for="avatar-upload-input" class="user-icon-wrapper" title="„Ç¢„Ç§„Ç≥„É≥„ÇíÂ§âÊõ¥">
                        <img id="user-icon" src="" alt="icon">
                        <div class="icon-edit-overlay"><i class="fas fa-camera"></i></div>
                    </label>
                    <input type="file" id="avatar-upload-input" accept="image/*">
                    <div id="user-details">
                        <span id="user-name"></span>
                        <button id="edit-name-btn" class="edit-btn">ÂêçÂâç„ÇíÂ§âÊõ¥</button>
                    </div>
                    <button id="logout-btn" class="auth-btn btn-logout">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>
            <div id="filter-section">
                <select id="sort-select" class="sort-select">
                    <option value="newest">üïí Êñ∞ÁùÄÈ†Ü</option>
                    <option value="likes">‚ù§Ô∏è „ÅÑ„ÅÑ„Å≠È†Ü</option>
                </select>
                <div style="font-size: 10px; color: #adb5bd; margin-left: 10px; font-weight: 500;">‚Äª2ÊôÇÈñì‰ª•ÂÜÖ„ÇíË°®Á§∫</div>
            </div>
            <div id="sidebar-content">
                <ul id="comment-list"><div id="loading-spinner" class="loader"></div></ul>
            </div>
        </div>
        <div id="mapid">
            <button id="sidebar-toggle" onclick="toggleSidebar()">‚óÄ</button>
            <button id="gps-btn" title="ÁèæÂú®Âú∞„Å∏"><i class="fas fa-location-arrow"></i></button>
        </div>
    </div>

    <div id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCZxC2imSus21qmrN4OelItvq9pyGJm0sE",
          authDomain: "chiyoda-map-sns.firebaseapp.com",
          projectId: "chiyoda-map-sns",
          storageBucket: "chiyoda-map-sns.firebasestorage.app",
          messagingSenderId: "140311034396",
          appId: "1:140311034396:web:eff090822e46f6d5787dd9"
        };

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        function showToast(message, type = 'normal') {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show " + type;
            setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
        }

        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            var btn = document.getElementById('sidebar-toggle');
            if(sb.style.display === 'none') { sb.style.display = 'flex'; btn.innerText = '‚óÄ'; }
            else { sb.style.display = 'none'; btn.innerText = '‚ñ∂'; }
        }

        window.onload = function() {
            if (typeof L === 'undefined') { alert('Âú∞Âõ≥„Ç®„É©„Éº'); return; }
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(e=>{});

            var center = [35.685175, 139.752762];
            var map = L.map('mapid', { zoomControl: false }).setView(center, 14);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap', className: '' }).addTo(map);

            var markersMap = {};
            var currentPostsData = []; 
            var currentLocationMarker = null;
            var currentUser = null;
            var userProfile = { name: "", photo: "" };
            var unsubscribe = null;
            var selectedDocId = null;

            document.getElementById('login-btn').onclick = () => auth.signInWithPopup(provider).catch(e => showToast(e.message, 'error'));
            document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => showToast("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü"));
            
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    await loadUserProfile(user);
                    document.getElementById('login-btn').style.display='none';
                    document.getElementById('user-info').style.display='flex';
                    updateProfileUI();
                } else {
                    document.getElementById('login-btn').style.display='block';
                    document.getElementById('user-info').style.display='none';
                    userProfile = { name: "", photo: "" };
                }
                setupDataListener();
            });

            async function loadUserProfile(user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    userProfile.name = data.handleName || user.displayName;
                    userProfile.photo = data.photoURL || user.photoURL;
                } else {
                    userProfile.name = user.displayName;
                    userProfile.photo = user.photoURL;
                    await db.collection('users').doc(user.uid).set({
                        handleName: userProfile.name, photoURL: userProfile.photo, updatedAt: new Date().toISOString()
                    });
                }
            }

            function updateProfileUI() {
                document.getElementById('user-name').textContent = userProfile.name;
                document.getElementById('user-icon').src = userProfile.photo;
            }

            document.getElementById('edit-name-btn').onclick = async function() {
                const newName = prompt("Êñ∞„Åó„ÅÑÂêçÂâç:", userProfile.name);
                if(newName && newName.trim()) {
                    await db.collection('users').doc(currentUser.uid).update({ handleName: newName });
                    userProfile.name = newName; updateProfileUI();
                    showToast("ÂêçÂâç„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü", 'success');
                }
            };

            document.getElementById('avatar-upload-input').onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 500 * 1024) { showToast("ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô", 'error'); return; }
                const reader = new FileReader();
                reader.onload = async function(evt) {
                    const base64 = evt.target.result;
                    try {
                        await db.collection('users').doc(currentUser.uid).update({ photoURL: base64 });
                        userProfile.photo = base64; updateProfileUI();
                        showToast("„Ç¢„Ç§„Ç≥„É≥„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü", 'success');
                    } catch(err) { showToast("Êõ¥Êñ∞Â§±Êïó", 'error'); }
                };
                reader.readAsDataURL(file);
            };

            function setupDataListener() {
                if(unsubscribe) unsubscribe();
                unsubscribe = db.collection("posts").onSnapshot((snapshot) => {
                    const spinner = document.getElementById('loading-spinner');
                    if (spinner) spinner.style.display = 'none';
                    
                    currentPostsData = [];
                    snapshot.forEach(doc => {
                        currentPostsData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const currentIds = currentPostsData.map(p => p.id);
                    Object.keys(markersMap).forEach(id => {
                        if (!currentIds.includes(id)) {
                            map.removeLayer(markersMap[id]);
                            delete markersMap[id];
                        }
                    });

                    refreshUI(); 
                });
            }

            // üåü ÊäïÁ®ø„ÇíÈÅ∏Êäû„Åô„ÇãÂá¶ÁêÜÔºàÂÖ±ÈÄöÂåñÔºâ
            function selectPost(docId) {
                selectedDocId = docId;
                
                // 1. „Éî„É≥„ÅÆÂº∑Ë™ø
                Object.keys(markersMap).forEach(id => {
                    const marker = markersMap[id];
                    const elem = marker.getElement();
                    if (elem) {
                        if (id === docId) {
                            elem.classList.add('highlight-pin');
                            marker.setZIndexOffset(100000);
                        } else {
                            elem.classList.remove('highlight-pin');
                            const data = currentPostsData.find(p => p.id === id);
                            const likeCount = data && data.likedBy ? data.likedBy.length : 0;
                            marker.setZIndexOffset(likeCount * 100);
                        }
                    }
                });

                // 2. „É™„Çπ„Éà„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„Å®Âº∑Ë™ø
                const listItem = document.getElementById('post-' + docId);
                if (listItem) {
                    document.querySelectorAll('.comment-item').forEach(el => el.classList.remove('active'));
                    listItem.classList.add('active');
                    listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // 3. Âú∞Âõ≥ÁßªÂãï
                if (markersMap[docId]) {
                    map.panTo(markersMap[docId].getLatLng());
                }
            }

            function refreshUI() {
                const sortMode = document.getElementById('sort-select').value;
                const list = document.getElementById('comment-list');
                list.innerHTML = ""; 

                const now = new Date();
                const limitMs = 2 * 60 * 60 * 1000; 

                let filteredData = currentPostsData.filter(item => {
                    const date = new Date(item.date);
                    const diffMs = now - date;
                    return diffMs < limitMs;
                });

                filteredData.sort((a, b) => {
                    if (sortMode === 'newest') return new Date(b.date) - new Date(a.date);
                    else if (sortMode === 'likes') {
                        const likeA = a.likedBy ? a.likedBy.length : 0;
                        const likeB = b.likedBy ? b.likedBy.length : 0;
                        if (likeB !== likeA) return likeB - likeA;
                        return new Date(b.date) - new Date(a.date);
                    }
                });

                filteredData.forEach(data => {
                    const docId = data.id;
                    const likeCount = data.likedBy ? data.likedBy.length : 0;

                    // „Éû„Éº„Ç´„ÉºÂá¶ÁêÜ
                    if (!markersMap[docId]) {
                        const icon = createCustomIcon(data.text, data.image, data.category);
                        const marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                        
                        // „Éû„Éº„Ç´„Éº„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆ„Ç§„Éô„É≥„Éà (ËøΩÂä†)
                        marker.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            selectPost(docId);
                        });

                        markersMap[docId] = marker;
                    } else {
                        const marker = markersMap[docId];
                        marker.setIcon(createCustomIcon(data.text, data.image, data.category));
                    }

                    // Z-indexÊõ¥Êñ∞
                    const marker = markersMap[docId];
                    if (docId === selectedDocId) {
                        marker.setZIndexOffset(100000);
                        setTimeout(() => { if(marker.getElement()) marker.getElement().classList.add('highlight-pin'); }, 0);
                    } else {
                        marker.setZIndexOffset(likeCount * 100);
                        if(marker.getElement()) marker.getElement().classList.remove('highlight-pin');
                    }

                    addSidebarItem(docId, data);
                });
            }

            document.getElementById('sort-select').onchange = refreshUI;

            map.on('click', function(e) {
                if(e.originalEvent.target.closest('button')) return;
                
                // ÈÅ∏ÊäûËß£Èô§
                selectedDocId = null;
                document.querySelectorAll('.highlight-pin').forEach(el => el.classList.remove('highlight-pin'));
                document.querySelectorAll('.comment-item').forEach(el => el.classList.remove('active'));
                
                const container = document.createElement('div');
                container.className = 'comment-form';
                
                if (!currentUser) {
                    container.innerHTML = `<div style="font-size:12px;color:red;margin-bottom:10px;">ÊäïÁ®ø„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</div>`;
                } else {
                    container.innerHTML = `
                        <div class="form-header"><b>${userProfile.name}</b> „Å®„Åó„Å¶ÊäïÁ®ø</div>
                        <div class="category-selector">
                            <input type="radio" name="cat" id="cat-gourmet" value="gourmet" class="cat-radio">
                            <label for="cat-gourmet" class="cat-label" title="„Ç∞„É´„É°">üç¥</label>
                            <input type="radio" name="cat" id="cat-view" value="view" class="cat-radio">
                            <label for="cat-view" class="cat-label" title="È¢®ÊôØ">üóª</label>
                            <input type="radio" name="cat" id="cat-event" value="event" class="cat-radio">
                            <label for="cat-event" class="cat-label" title="„Ç§„Éô„É≥„Éà">üéâ</label>
                            <input type="radio" name="cat" id="cat-other" value="other" class="cat-radio" checked>
                            <label for="cat-other" class="cat-label" title="„Åù„ÅÆ‰ªñ">üí¨</label>
                        </div>
                        <input type="text" id="post-text" class="comment-input" placeholder="„Ç≥„É°„É≥„Éà...">
                        <div class="form-actions">
                            <label for="post-file-input" class="image-upload-label" id="file-label"><i class="fas fa-camera"></i></label>
                            <input type="file" id="post-file-input" accept="image/*">
                            <button id="submit-post" class="comment-btn">ÊäïÁ®ø</button>
                        </div>
                    `;
                }
                L.popup().setLatLng(e.latlng).setContent(container).openOn(map);

                setTimeout(() => {
                    if(!currentUser) return;
                    const fileInput = document.getElementById('post-file-input');
                    const label = document.getElementById('file-label');
                    const btn = document.getElementById('submit-post');
                    
                    fileInput.onchange = () => {
                        if(fileInput.files.length > 0) label.classList.add('has-file');
                        else label.classList.remove('has-file');
                    };

                    btn.onclick = () => {
                        const text = document.getElementById('post-text').value;
                        const category = document.querySelector('input[name="cat"]:checked').value;
                        if(!text) return showToast("„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", 'error');
                        
                        const file = fileInput.files[0];
                        if (file) {
                            if (file.size > 800 * 1024) return showToast("ÁîªÂÉè„Çµ„Ç§„Ç∫ÈÅéÂ§ß", 'error');
                            const reader = new FileReader();
                            reader.onload = (evt) => submitPost(e.latlng, text, evt.target.result, category);
                            reader.readAsDataURL(file);
                        } else {
                            submitPost(e.latlng, text, null, category);
                        }
                    };
                }, 100);
            });

            function submitPost(latlng, text, imageData, category) {
                db.collection("posts").add({
                    lat: latlng.lat, lng: latlng.lng, text: text, image: imageData, category: category,
                    date: new Date().toISOString(), uid: currentUser.uid,
                    authorName: userProfile.name, authorPhoto: userProfile.photo, likedBy: []
                }).then(() => {
                    map.closePopup();
                    showToast("ÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ", 'success');
                }).catch(e => showToast(e.message, 'error'));
            }

            function addSidebarItem(docId, data) {
                const list = document.getElementById('comment-list');
                const li = document.createElement('li');
                li.className = 'comment-item';
                li.id = 'post-' + docId; // ID‰ªò‰∏é
                
                if (docId === selectedDocId) li.classList.add('active');
                if (data.category) li.classList.add('cat-' + data.category);
                if (currentUser && data.uid === currentUser.uid) li.classList.add('my-post');

                const avatar = document.createElement('img');
                avatar.className = 'item-avatar';
                avatar.src = data.authorPhoto || 'https://placehold.co/40';
                li.appendChild(avatar);

                const body = document.createElement('div');
                body.className = 'item-body';
                
                const header = document.createElement('div');
                header.className = 'item-header';
                const timeStr = new Date(data.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                header.innerHTML = `<span class="item-author">${data.authorName}</span> <span class="item-time">${timeStr}</span>`;
                body.appendChild(header);

                const textDiv = document.createElement('div');
                textDiv.className = 'item-text';
                textDiv.innerHTML = formatTextWithHashtags(data.text);
                body.appendChild(textDiv);

                const footer = document.createElement('div');
                footer.className = 'item-footer';
                
                const likeBtn = document.createElement('button');
                likeBtn.className = 'item-btn item-like-btn';
                const likeCount = data.likedBy ? data.likedBy.length : 0;
                const isLiked = currentUser && data.likedBy && data.likedBy.includes(currentUser.uid);
                
                likeBtn.innerHTML = `<i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${likeCount || ''}`;
                if(isLiked) likeBtn.classList.add('liked');

                likeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(!currentUser) return showToast("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ", 'error');
                    const postRef = db.collection("posts").doc(docId);
                    if (isLiked) {
                        postRef.update({ likedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                    } else {
                        postRef.update({ likedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                    }
                };
                footer.appendChild(likeBtn);

                // ‚òÖ „Ç∑„Çß„Ç¢„Éú„Çø„É≥ËøΩÂä†
                const shareBtn = document.createElement('button');
                shareBtn.className = 'item-btn item-share-btn';
                shareBtn.innerHTML = '<i class="fas fa-share-alt"></i>';
                shareBtn.title = "„Ç∑„Çß„Ç¢";
                shareBtn.onclick = (e) => {
                    e.stopPropagation();
                    const shareUrl = window.location.href.split('?')[0]; // „ÇØ„Ç®„É™ÂâäÈô§
                    const shareText = `„Äå${data.text}„Äç\n#ÂçÉ‰ª£Áî∞Âå∫„Éû„ÉÉ„ÉóSNS`;
                    
                    if (navigator.share) {
                        navigator.share({ title: 'ÂçÉ‰ª£Áî∞Âå∫„Ç≥„É°„É≥„Éà„Éû„ÉÉ„Éó', text: shareText, url: shareUrl })
                        .catch(console.error);
                    } else {
                        // Twitter„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        const twUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
                        window.open(twUrl, '_blank');
                    }
                };
                footer.appendChild(shareBtn);

                const delBtn = document.createElement('button');
                delBtn.className = 'item-btn item-delete-btn';
                delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                        db.collection("posts").doc(docId).delete().then(()=>showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü"));
                    }
                };
                footer.appendChild(delBtn);
                
                body.appendChild(footer);
                li.appendChild(body);

                if (data.image) {
                    const thumb = document.createElement('img');
                    thumb.className = 'item-right-img';
                    thumb.src = data.image;
                    li.appendChild(thumb);
                }

                li.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    selectPost(docId);
                };
                list.appendChild(li);
            }

            function createCustomIcon(text, image, category) {
                if(text.length > 10) text = text.substring(0, 10) + "...";
                
                let circleClass = 'marker-circle';
                let circleStyle = '';
                const catClass = category ? 'category-' + category : 'category-other';

                if (image) {
                    circleClass += ' has-image';
                    circleStyle = `background-image: url('${image}');`;
                } else {
                    circleClass += ' no-image';
                }

                const html = `
                    <div class="marker-container ${catClass}">
                        <div class="marker-bubble">
                            <span class="marker-content">${text}</span>
                        </div>
                        <div class="${circleClass}" style="${circleStyle}"></div>
                    </div>`;
                
                return L.divIcon({ html: html, className: '', iconSize: [120, 70], iconAnchor: [60, 65] });
            }

            function formatTextWithHashtags(text) { 
                return text ? text.replace(/(#\S+)/g, '<span class="hashtag">$1</span>') : ""; 
            }

            document.getElementById('gps-btn').onclick = function() {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(pos => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(latlng, 16);
                    if (currentLocationMarker) currentLocationMarker.setLatLng(latlng);
                    else {
                        currentLocationMarker = L.circleMarker(latlng, { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                    }
                    currentLocationMarker.bindPopup("ÁèæÂú®Âú∞").openPopup();
                });
            };
        };
    </script>
</body>
</html>