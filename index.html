<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂçÉ‰ª£Áî∞Âå∫„Ç≥„É°„É≥„Éà„Éû„ÉÉ„Éó</title>
    
    <!-- PWAË®≠ÂÆö -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        body { margin: 0; padding: 0; overflow: hidden; font-family: "Helvetica Neue", Arial, sans-serif; color: #333; }
        #container { display: flex; height: 100vh; width: 100vw; position: relative; }

        /* --- „Çµ„Ç§„Éâ„Éê„Éº --- */
        #sidebar {
            width: 320px; background-color: #f9f9f9; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; z-index: 2000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: transform 0.3s ease;
            position: absolute; height: 100%; left: 0; top: 0;
        }
        #sidebar.hidden { transform: translateX(-100%); }
        #sidebar-toggle {
            position: absolute; top: 10px; left: 330px; z-index: 2001;
            background-color: white; border: 2px solid #007bff; color: #007bff;
            border-radius: 4px; padding: 8px 12px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: left 0.3s ease;
        }
        #sidebar.hidden + #mapid #sidebar-toggle { left: 10px; background-color: #007bff; color: white; }
        
        /* „É≠„Ç∞„Ç§„É≥„Ç®„É™„Ç¢ */
        #login-section {
            padding: 15px; background-color: #fff; border-bottom: 1px solid #ddd;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        #user-info { display: none; align-items: center; gap: 10px; width: 100%; }
        #user-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd;}
        #user-name { font-weight: bold; font-size: 14px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .auth-btn {
            width: 100%; padding: 8px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 14px;
        }
        .btn-login { background-color: #4285f4; color: white; } /* Google Blue */
        .btn-logout { background-color: #eee; color: #333; width: auto; font-size: 12px; padding: 5px 10px;}

        #sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
        #hashtag-section {
            padding: 15px 20px; background-color: #fff; border-top: 1px solid #ddd;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05); max-height: 150px; overflow-y: auto;
        }

        #mapid { flex: 1; height: 100%; background-color: #eee; position: relative; width: 100%; }
        #gps-btn {
            position: absolute; bottom: 30px; right: 60px; z-index: 1000;
            background-color: white; border: 2px solid #ccc; border-radius: 4px;
            padding: 8px 12px; cursor: pointer; font-weight: bold; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px;
        }

        /* ÁîªÂÉè„Çπ„Çø„Ç§„É´ */
        .post-image { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; margin-top: 8px; border: 1px solid #ddd; }
        .pin-thumbnail { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: block; margin: 0 auto 5px auto; background-color: #ddd; }

        /* „Ç≥„É°„É≥„Éà„É™„Çπ„Éà */
        h2 { font-size: 18px; margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #007bff; color: #333; }
        h3 { font-size: 14px; margin: 0 0 10px 0; color: #555; }
        #comment-list { list-style: none; padding: 0; margin: 0; }
        .comment-item {
            background-color: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #ccc; /* Êú™„É≠„Ç∞„Ç§„É≥ÊäïÁ®ø„ÅØ„Ç∞„É¨„Éº */
            position: relative; transition: 0.2s; cursor: pointer;
        }
        .comment-item.my-post { border-left-color: #007bff; background-color: #f9fcff; } /* Ëá™ÂàÜ„ÅÆÊäïÁ®ø */
        
        .comment-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .comment-item.active { border-left-color: #ff4081; background-color: #fff0f5; }
        
        .comment-header { display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; color: #666; gap: 8px; }
        .author-icon { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .author-name { font-weight: bold; color: #333; margin-right: auto; }
        .post-time { font-size: 11px; }

        .comment-text { display: block; margin-bottom: 5px; font-size: 14px; line-height: 1.5; pointer-events: none; }
        .hashtag { color: #007bff; background: #eef6ff; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-right: 2px; }
        .comment-actions { display: flex; align-items: center; border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; }
        
        .like-btn { background: none; border: 1px solid #ff4081; color: #ff4081; border-radius: 20px; padding: 3px 10px; font-size: 12px; cursor: pointer; transition: 0.2s; z-index: 2; }
        .like-btn:hover, .like-btn.liked { background-color: #ff4081; color: white; }
        
        /* ÂâäÈô§„Éú„Çø„É≥ */
        .delete-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ccc; font-size: 18px; cursor: pointer; z-index: 2; display: none; }
        .delete-btn:hover { color: #ff4444; }
        /* Ëá™ÂàÜ„ÅÆÊäïÁ®ø„Å´„Å†„ÅëÂâäÈô§„Éú„Çø„É≥„ÇíË°®Á§∫„Åô„Çã„ÇØ„É©„Çπ */
        .my-post .delete-btn { display: block; }

        .popular-tag { display: inline-block; background-color: #eef6ff; color: #007bff; border-radius: 20px; padding: 5px 10px; margin: 0 5px 5px 0; font-size: 12px; font-weight: bold; border: 1px solid #b3d7ff; }
        .popular-tag-count { background-color: #007bff; color: white; border-radius: 50%; padding: 0 5px; margin-left: 5px; font-size: 10px; }

        /* „Ç´„Çπ„Çø„É†„Éû„Éº„Ç´„Éº */
        .custom-pin-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        .custom-pin-bubble {
            background-color: #fff; color: #333; border: 2px solid #333; border-radius: 8px;
            padding: 6px 10px; font-size: 12px; font-weight: bold; white-space: nowrap;
            box-shadow: 2px 4px 6px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 5px;
            transition: transform 0.2s; margin-bottom: 5px;
        }
        .highlight-pin .custom-pin-bubble { background-color: #ff4081; color: white; border-color: #c51162; transform: scale(1.1); z-index: 9999; }
        .highlight-pin .custom-pin-bubble::after { border-top-color: #333; }
        .custom-pin-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; margin-left: -8px;
            border-width: 8px 8px 0; border-style: solid; border-color: #333 transparent transparent transparent;
        }
        .custom-pin-dot { width: 12px; height: 12px; background-color: #007bff; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5); }
        .pin-user-icon { width: 16px; height: 16px; border-radius: 50%; object-fit: cover; margin-right: 3px; }

        /* „Éï„Ç©„Éº„É† */
        .comment-form { text-align: center; width: 220px; }
        .comment-input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .file-input { width: 100%; margin-bottom: 10px; font-size: 12px; }
        .comment-btn { width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .comment-btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="container">
        <div id="sidebar">
            <!-- „É≠„Ç∞„Ç§„É≥„Ç®„É™„Ç¢ -->
            <div id="login-section">
                <!-- Êú™„É≠„Ç∞„Ç§„É≥ÊôÇ -->
                <button id="login-btn" class="auth-btn btn-login">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                
                <!-- „É≠„Ç∞„Ç§„É≥ÊôÇ -->
                <div id="user-info">
                    <img id="user-icon" src="" alt="icon">
                    <span id="user-name"></span>
                    <button id="logout-btn" class="auth-btn btn-logout">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>

            <div id="sidebar-content">
                <h2>üìç „Åø„Çì„Å™„ÅÆÊäïÁ®ø</h2>
                <ul id="comment-list">
                    <li id="loading-msg" style="text-align:center; color:#999; margin-top:30px;">
                        „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                    </li>
                </ul>
            </div>
            <div id="hashtag-section">
                <h3>üìà ‰∫∫Ê∞ó„ÅÆ„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞</h3>
                <div id="popular-hashtags-list" style="font-size: 12px; color: #888;">ÈõÜË®à‰∏≠...</div>
            </div>
        </div>

        <div id="mapid">
            <button id="sidebar-toggle">‚óÄ „É™„Çπ„Éà„ÇíÈö†„Åô</button>
            <button id="gps-btn">üìç ÁèæÂú®Âú∞„Å∏</button>
        </div>
    </div>

    <!-- Firebase„É©„Ç§„Éñ„É©„É™ (Auth„ÇíËøΩÂä†) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        // =========================================================
        // üî• ÈáçË¶Å: ‰ªñ„ÅÆË®≠ÂÆö(projectIdÁ≠â)„ÇÇÂøÖ„ÅöÊõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºÅ
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCZxC2imSus21qmrN4OelItvq9pyGJm0sE", // API„Ç≠„Éº
            authDomain: "chiyoda-map-sns.firebaseapp.com",      // ‚Üê„Åì„Åì„Å™„Å©„ÇíÊõ∏„ÅçÊèõ„Åà
            projectId: "chiyoda-map-sns",                       // ‚Üê„Åì„Åì„Å™„Å©„ÇíÊõ∏„ÅçÊèõ„Åà
            storageBucket: "chiyoda-map-sns.appspot.com",       // ‚Üê„Åì„Åì„Å™„Å©„ÇíÊõ∏„ÅçÊèõ„Åà
            messagingSenderId: "123456789012",                  // ‚Üê„Åì„Åì„Å™„Å©„ÇíÊõ∏„ÅçÊèõ„Åà
            appId: "1:123456789012:web:abcdef123456"            // ‚Üê„Åì„Åì„Å™„Å©„ÇíÊõ∏„ÅçÊèõ„Åà
        };
        // =========================================================

        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.error("FirebaseÂàùÊúüÂåñ„Ç®„É©„Éº", e);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        window.onload = function() {
            if (typeof L === 'undefined') { alert('Âú∞Âõ≥„Ç®„É©„Éº'); return; }

            // PWAÁôªÈå≤
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js').catch(e => console.log('SWÂ§±Êïó:', e));
            }

            // Âú∞Âõ≥ÂàùÊúüÂåñ
            var center = [35.685175, 139.752762];
            var map = L.map('mapid', { zoomControl: false }).setView(center, 14);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: '¬© OpenStreetMap', className: 'grayscale-tile'
            }).addTo(map);

            var worldLatLngs = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
            var chiyodaHole = [[35.706, 139.728], [35.706, 139.784], [35.668, 139.784], [35.668, 139.728]];
            L.polygon([worldLatLngs, chiyodaHole], { color: 'transparent', fillColor: '#000', fillOpacity: 0.6, interactive: false }).addTo(map);

            // Áä∂ÊÖãÁÆ°ÁêÜ
            var markersMap = {};
            var hashtagStats = {};
            var topZIndex = 1000;
            var currentLocationMarker = null;
            var currentUser = null; // „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±
            var unsubscribe = null; // „É™„Çπ„Éä„ÉºËß£Èô§Áî®

            // --------------------------------------------------------
            // üîê „É≠„Ç∞„Ç§„É≥„Éª„É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
            // --------------------------------------------------------
            document.getElementById('login-btn').onclick = function() {
                auth.signInWithPopup(provider).catch(function(error) {
                    alert("„É≠„Ç∞„Ç§„É≥Â§±Êïó: " + error.message);
                });
            };

            document.getElementById('logout-btn').onclick = function() {
                auth.signOut().then(() => {
                    alert("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü");
                });
            };

            // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
            auth.onAuthStateChanged(function(user) {
                currentUser = user; // Áä∂ÊÖã„Çí‰øùÂ≠ò
                updateLoginUI(user);
                
                // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÅåÂ§â„Çè„Å£„Åü„Çâ„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„ÅøÔºàÂâäÈô§„Éú„Çø„É≥„ÅÆË°®Á§∫„Å™„Å©„ÇíÊõ¥Êñ∞„Åô„Çã„Åü„ÇÅÔºâ
                setupDataListener();
            });

            function updateLoginUI(user) {
                if (user) {
                    document.getElementById('login-btn').style.display = 'none';
                    document.getElementById('user-info').style.display = 'flex';
                    document.getElementById('user-icon').src = user.photoURL;
                    document.getElementById('user-name').textContent = user.displayName;
                } else {
                    document.getElementById('login-btn').style.display = 'block';
                    document.getElementById('user-info').style.display = 'none';
                }
            }

            // --------------------------------------------------------
            // üî• „Éá„Éº„ÇøË™≠„ÅøËæº„Åø (ÂÜçÂà©Áî®ÂèØËÉΩ„Å™Èñ¢Êï∞)
            // --------------------------------------------------------
            function setupDataListener() {
                // Êó¢„Å´Áõ£Ë¶ñ‰∏≠„Å™„Çâ‰∏ÄÂ∫¶Ëß£Èô§
                if(unsubscribe) unsubscribe();

                unsubscribe = db.collection("posts").orderBy("date", "desc").onSnapshot((snapshot) => {
                    document.getElementById('loading-msg').style.display = 'none';
                    var list = document.getElementById('comment-list');
                    list.innerHTML = "";
                    hashtagStats = {}; 

                    snapshot.forEach((doc) => {
                        var data = doc.data();
                        var docId = doc.id; 
                        
                        // „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞ÈõÜË®à
                        var tags = data.text.match(/(#\S+)/g);
                        if(tags) tags.forEach(t => { hashtagStats[t] = (hashtagStats[t] || 0) + 1; });

                        // „Éû„Éº„Ç´„ÉºÊõ¥Êñ∞
                        if (!markersMap[docId]) {
                            var styledText = formatTextWithHashtags(data.text);
                            var customIcon = createCustomIcon(docId, styledText, data.likeCount, data.image, data.authorPhoto);
                            var marker = L.marker([data.lat, data.lng], { icon: customIcon }).addTo(map);
                            markersMap[docId] = marker;
                        } else {
                            var marker = markersMap[docId];
                            var styledText = formatTextWithHashtags(data.text);
                            var newIcon = createCustomIcon(docId, styledText, data.likeCount, data.image, data.authorPhoto);
                            marker.setIcon(newIcon);
                        }
                        
                        // „É™„Çπ„ÉàËøΩÂä†
                        addSidebarItem(docId, data, markersMap[docId]);
                    });
                    renderPopularHashtags();
                });
            }

            // --------------------------------------------------------
            // üñ±Ô∏è ÊäïÁ®øÊ©üËÉΩ
            // --------------------------------------------------------
            map.on('click', function(e) {
                if(e.originalEvent.target.id === 'gps-btn' || e.originalEvent.target.id === 'sidebar-toggle') return;

                var container = document.createElement('div');
                container.className = 'comment-form';
                
                if (!currentUser) {
                    container.innerHTML = `<div style="margin-bottom:10px; font-size:12px; color:red;">ÊäïÁ®ø„Åô„Çã„Å´„ÅØ<br>„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>`;
                } else {
                    container.innerHTML = `<div style="margin-bottom:5px;"><b>Êñ∞„Åó„ÅÑÊäïÁ®ø</b></div>`;
                    
                    var input = document.createElement('input');
                    input.type = "text"; input.placeholder = "#„Çø„Ç∞ „Ç≥„É°„É≥„Éà..."; input.className = 'comment-input';
                    container.appendChild(input);

                    var fileInput = document.createElement('input');
                    fileInput.type = "file"; fileInput.accept = "image/*"; fileInput.className = "file-input";
                    container.appendChild(fileInput);

                    var btn = document.createElement('button');
                    btn.innerText = "ÊäïÁ®ø"; btn.className = 'comment-btn';

                    btn.onclick = function() {
                        var text = input.value;
                        if(!text) { alert("„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
                        
                        var file = fileInput.files[0];
                        if (file) {
                            if(file.size > 800 * 1024) { alert("ÁîªÂÉè„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô"); return; }
                            var reader = new FileReader();
                            reader.onload = function(evt) { submitToFirebase(e.latlng, text, evt.target.result); };
                            reader.readAsDataURL(file);
                        } else {
                            submitToFirebase(e.latlng, text, null);
                        }
                    };
                    container.appendChild(btn);
                }
                L.popup().setLatLng(e.latlng).setContent(container).openOn(map);
            });

            function submitToFirebase(latlng, text, imageData) {
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí‰ªò‰∏é„Åó„Å¶‰øùÂ≠ò
                db.collection("posts").add({
                    lat: latlng.lat,
                    lng: latlng.lng,
                    text: text,
                    image: imageData, 
                    likeCount: 0,
                    date: new Date().toISOString(),
                    uid: currentUser.uid,              // Ë™∞„ÅåÊäïÁ®ø„Åó„Åü„Åã(ID)
                    authorName: currentUser.displayName, // ÂêçÂâç
                    authorPhoto: currentUser.photoURL    // „Ç¢„Ç§„Ç≥„É≥URL
                }).then(() => {
                    map.closePopup();
                }).catch((error) => {
                    alert("ÊäïÁ®øÂ§±Êïó: " + error.message);
                });
            }

            function addSidebarItem(docId, data, marker) {
                var list = document.getElementById('comment-list');
                var li = document.createElement('li');
                li.className = 'comment-item';
                
                // Ëá™ÂàÜ„ÅÆÊäïÁ®ø„Å™„Çâ„ÇØ„É©„Çπ„ÇíËøΩÂä†ÔºàËâ≤„ÇíÂ§â„Åà„Çã„Åü„ÇÅÔºâ
                if (currentUser && data.uid === currentUser.uid) {
                    li.classList.add('my-post');
                }

                li.onclick = function(e) {
                    if (e.target.closest('.delete-btn') || e.target.closest('.like-btn')) return;
                    topZIndex++; marker.setZIndexOffset(topZIndex); map.panTo(marker.getLatLng());
                    var el = marker.getElement();
                    if(el) {
                        document.querySelectorAll('.highlight-pin').forEach(e=>e.classList.remove('highlight-pin'));
                        el.classList.add('highlight-pin');
                        document.querySelectorAll('.comment-item').forEach(e=>e.classList.remove('active'));
                        li.classList.add('active');
                        if(window.innerWidth<600) { document.getElementById('sidebar').classList.add('hidden'); document.getElementById('sidebar-toggle').innerText="‚ñ∂"; document.getElementById('sidebar-toggle').style.left="10px"; }
                    }
                };

                // ÂâäÈô§„Éú„Çø„É≥ (Ëá™ÂàÜ„ÅÆÊäïÁ®ø„ÅÆ„ÅøË°®Á§∫„Åï„Çå„ÇãÂà∂Âæ°„ÅØCSS„ÅßË°å„ÅÜ)
                var delBtn = document.createElement('button');
                delBtn.className = 'delete-btn';
                delBtn.innerHTML = '&times;';
                delBtn.onclick = function(e) {
                    e.stopPropagation();
                    if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                        db.collection("posts").doc(docId).delete().then(() => {
                            map.removeLayer(marker); delete markersMap[docId];
                        }).catch(e => alert(e));
                    }
                };
                li.appendChild(delBtn);

                // „Éò„ÉÉ„ÉÄ„ÉºÔºà„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ôºâ
                var header = document.createElement('div');
                header.className = 'comment-header';
                
                // „Ç¢„Ç§„Ç≥„É≥„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫„ÄÅ„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà
                var iconUrl = data.authorPhoto || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';
                var name = data.authorName || 'ÂêçÁÑ°„Åó';
                
                var dateObj = new Date(data.date);
                var timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                header.innerHTML = `
                    <img class="author-icon" src="${iconUrl}">
                    <span class="author-name">${name}</span>
                    <span class="post-time">${timeStr}</span>
                `;
                li.appendChild(header);

                if (data.image) {
                    var img = document.createElement('img');
                    img.src = data.image; img.className = 'post-image'; li.appendChild(img);
                }

                var content = document.createElement('div');
                content.className = 'comment-text';
                content.innerHTML = formatTextWithHashtags(data.text);
                li.appendChild(content);

                var actions = document.createElement('div');
                actions.className = 'comment-actions';
                var likeBtn = document.createElement('button');
                likeBtn.className = 'like-btn';
                likeBtn.innerHTML = data.likeCount > 0 ? `‚ù§Ô∏è ${data.likeCount}` : '‚ù§Ô∏è „ÅÑ„ÅÑ„Å≠';
                if(data.likeCount > 0) likeBtn.classList.add('liked');
                
                likeBtn.onclick = function(e) {
                    e.stopPropagation();
                    db.collection("posts").doc(docId).update({ likeCount: (data.likeCount || 0) + 1 });
                };
                actions.appendChild(likeBtn);
                li.appendChild(actions);
                list.appendChild(li); 
            }

            function createCustomIcon(id, text, likeCount, imageData, userIcon) {
                var likeHtml = likeCount > 0 ? ` <span style="color:#ff4081">‚ù§Ô∏è${likeCount}</span>` : '';
                var thumbHtml = imageData ? `<img src="${imageData}" class="pin-thumbnail">` : '';
                var userIconHtml = userIcon ? `<img src="${userIcon}" class="pin-user-icon">` : ''; // „Éî„É≥„Å´„ÇÇ„É¶„Éº„Ç∂„Éº„Ç¢„Ç§„Ç≥„É≥
                
                var html = `
                    <div class="custom-pin-container">
                        ${thumbHtml}
                        <div class="custom-pin-bubble">
                            ${userIconHtml}
                            ${text}
                            ${likeHtml}
                        </div>
                        <div class="custom-pin-dot"></div>
                    </div>
                `;
                return L.divIcon({ html: html, className: '', iconSize: [0, 0], iconAnchor: [0, 0] });
            }

            function formatTextWithHashtags(text) { return text.replace(/(#\S+)/g, '<span class="hashtag">$1</span>'); }

            function renderPopularHashtags() {
                var container = document.getElementById('popular-hashtags-list');
                var sortedTags = Object.keys(hashtagStats).map(k => ({ tag: k, count: hashtagStats[k] })).sort((a,b) => b.count - a.count);
                if (sortedTags.length === 0) { container.innerHTML = "„Åæ„Å†„Çø„Ç∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì"; return; }
                container.innerHTML = "";
                sortedTags.slice(0, 10).forEach(i => {
                    var span = document.createElement('span');
                    span.className = 'popular-tag';
                    span.innerHTML = `${i.tag} <span class="popular-tag-count">${i.count}</span>`;
                    container.appendChild(span);
                });
            }

            // „Çµ„Ç§„Éâ„Éê„ÉºÈñãÈñâ
            var sidebar = document.getElementById('sidebar');
            var toggleBtn = document.getElementById('sidebar-toggle');
            toggleBtn.onclick = function() {
                sidebar.classList.toggle('hidden');
                if (sidebar.classList.contains('hidden')) { toggleBtn.innerText = "‚ñ∂"; toggleBtn.style.left = "10px"; }
                else { toggleBtn.innerText = "‚óÄ"; toggleBtn.style.left = "330px"; }
            };
            if (window.innerWidth < 600) { sidebar.classList.add('hidden'); toggleBtn.innerText = "‚ñ∂"; toggleBtn.style.left = "10px"; }

            // GPS
            document.getElementById('gps-btn').onclick = function() {
                if (!navigator.geolocation) return;
                this.innerText = "Ê∏¨‰Ωç‰∏≠...";
                navigator.geolocation.getCurrentPosition(
                    function(pos) {
                        var latlng = [pos.coords.latitude, pos.coords.longitude];
                        map.setView(latlng, 16);
                        if (currentLocationMarker) currentLocationMarker.setLatLng(latlng);
                        else {
                            currentLocationMarker = L.circleMarker(latlng, { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                            L.circle(latlng, { radius: pos.coords.accuracy/2, color: 'transparent', fillColor: '#3388ff', fillOpacity: 0.2 }).addTo(map);
                        }
                        currentLocationMarker.bindPopup("ÁèæÂú®Âú∞").openPopup();
                        document.getElementById('gps-btn').innerText = "üìç ÁèæÂú®Âú∞„Å∏";
                    },
                    function(err) { alert("‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº"); document.getElementById('gps-btn').innerText = "üìç ÁèæÂú®Âú∞„Å∏"; }
                );
            };
        };
    </script>
</body>
</html>