<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂçÉ‰ª£Áî∞Âå∫„Ç≥„É°„É≥„Éà„Éû„ÉÉ„Éó</title>
    
    <!-- PWAË®≠ÂÆö -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        body { margin: 0; padding: 0; overflow: hidden; font-family: "Helvetica Neue", Arial, sans-serif; color: #333; }
        
        #container { 
            display: flex; height: 100vh; width: 100vw; flex-direction: row; 
        }

        /* --- „Çµ„Ç§„Éâ„Éê„Éº --- */
        #sidebar {
            width: 320px; background-color: #fff; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; z-index: 2000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); position: relative;
        }

        /* --- Âú∞Âõ≥„Ç®„É™„Ç¢ --- */
        #mapid { 
            flex: 1; height: 100%; background-color: #eee; position: relative; 
        }

        /* „Çπ„Éû„ÉõÁî®„É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 600px) {
            #container { flex-direction: column; }
            #mapid { height: 55%; width: 100%; order: 1; }
            #sidebar { width: 100%; height: 45%; border-right: none; border-top: 1px solid #ddd; order: 2; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
            #sidebar-toggle { display: none; }
        }

        /* PCÁî®ÈñãÈñâ„Éú„Çø„É≥ */
        #sidebar-toggle {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background-color: white; border: 2px solid #007bff; color: #007bff;
            border-radius: 4px; padding: 5px 10px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* „É≠„Ç∞„Ç§„É≥„Ç®„É™„Ç¢ */
        #login-section {
            padding: 10px; background-color: #f8f9fa; border-bottom: 1px solid #ddd;
            display: flex; align-items: center; justify-content: space-between;
        }
        #user-info { display: none; align-items: center; gap: 8px; width: 100%; }
        #user-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #ccc;}
        
        /* „É¶„Éº„Ç∂„ÉºÂêç„Å®Á∑®ÈõÜ„Éú„Çø„É≥„ÅÆ„Ç≥„É≥„ÉÜ„Éä */
        #user-name-container {
            flex: 1; display: flex; align-items: center; gap: 5px; overflow: hidden;
        }
        #user-name { font-weight: bold; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        #edit-name-btn {
            background: none; border: none; cursor: pointer; font-size: 12px; padding: 2px;
            color: #007bff; display: flex; align-items: center; justify-content: center;
        }
        #edit-name-btn:hover { background-color: #eef6ff; border-radius: 4px; }
        
        .auth-btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-login { background-color: #4285f4; color: white; width: 100%; }
        .btn-logout { background-color: #eee; color: #333; white-space: nowrap; }

        #sidebar-content { flex: 1; overflow-y: auto; padding: 0; }
        #hashtag-section {
            padding: 10px; background-color: #f8f9fa; border-top: 1px solid #ddd;
            font-size: 11px; white-space: nowrap; overflow-x: auto;
        }

        #gps-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            background-color: white; border: 2px solid #ccc; border-radius: 50%;
            width: 40px; height: 40px; cursor: pointer; font-weight: bold; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        /* „Ç≥„É°„É≥„Éà„É™„Çπ„Éà */
        #comment-list { list-style: none; padding: 0; margin: 0; }
        .comment-item {
            display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; transition: background 0.2s; height: 50px;
        }
        .comment-item:hover { background-color: #f5f5f5; }
        .comment-item.active { background-color: #eef6ff; border-left: 4px solid #007bff; padding-left: 8px; }
        .comment-item.my-post { background-color: #fff; }

        .item-thumb { width: 36px; height: 36px; border-radius: 4px; object-fit: cover; margin-right: 10px; background-color: #eee; border: 1px solid #ddd; flex-shrink: 0; }
        .item-content { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .item-text { font-size: 13px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 10px; color: #999; display: flex; align-items: center; gap: 5px; }
        
        .item-actions { display: flex; align-items: center; gap: 8px; margin-left: 10px; }
        .item-like-btn { background: none; border: none; cursor: pointer; color: #ccc; font-size: 14px; padding: 0; display: flex; align-items: center; gap: 2px; }
        .item-like-btn.liked { color: #ff4081; }
        .item-delete-btn { background: none; border: none; cursor: pointer; color: #999; font-size: 18px; padding: 0 5px; display: none; }
        .item-delete-btn:hover { color: #ff4444; }
        .my-post .item-delete-btn { display: block; }

        .hashtag { color: #007bff; margin-right: 3px; }
        .popular-tag { display: inline-block; background-color: #fff; color: #007bff; border-radius: 12px; padding: 2px 8px; margin-right: 5px; border: 1px solid #b3d7ff; }

        .custom-pin-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        .custom-pin-bubble {
            background-color: #fff; color: #333; border: 2px solid #333; border-radius: 8px;
            padding: 4px 8px; font-size: 11px; font-weight: bold; white-space: nowrap;
            box-shadow: 2px 4px 6px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 4px;
            transition: transform 0.2s; margin-bottom: 4px;
        }
        .highlight-pin .custom-pin-bubble { background-color: #ff4081; color: white; border-color: #c51162; transform: scale(1.2); z-index: 9999; }
        .highlight-pin .custom-pin-bubble::after { border-top-color: #333; }
        .custom-pin-bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px 6px 0; border-style: solid; border-color: #333 transparent transparent transparent; }
        .custom-pin-dot { width: 10px; height: 10px; background-color: #007bff; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5); }
        .pin-thumbnail { width: 30px; height: 30px; object-fit: cover; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: block; margin: 0 auto 4px auto; background-color: #ddd; }

        .comment-form { text-align: center; width: 220px; }
        .comment-input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .file-input { width: 100%; margin-bottom: 10px; font-size: 12px; }
        .comment-btn { width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="container">
        <!-- üì± „Çπ„Éû„Éõ: ‰∏ã / PC: Â∑¶ -->
        <div id="sidebar">
            <div id="login-section">
                <button id="login-btn" class="auth-btn btn-login">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                <div id="user-info">
                    <img id="user-icon" src="" alt="icon">
                    <div id="user-name-container">
                        <span id="user-name"></span>
                        <button id="edit-name-btn" title="ÂêçÂâç„ÇíÂ§âÊõ¥">‚úèÔ∏è</button>
                    </div>
                    <button id="logout-btn" class="auth-btn btn-logout">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>

            <div id="sidebar-content">
                <ul id="comment-list">
                    <li id="loading-msg" style="text-align:center; color:#999; padding:20px; font-size:12px;">
                        Ë™≠„ÅøËæº„Åø‰∏≠...
                    </li>
                </ul>
            </div>
            
            <div id="hashtag-section"></div>
        </div>

        <!-- üì± „Çπ„Éû„Éõ: ‰∏ä / PC: Âè≥ -->
        <div id="mapid">
            <button id="sidebar-toggle" onclick="toggleSidebar()">‚óÄ</button>
            <button id="gps-btn" title="ÁèæÂú®Âú∞„Å∏">üìç</button>
        </div>
    </div>

    <!-- Firebase„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        // =========================================================
        // üî• ÈáçË¶Å: Ëá™ÂàÜ„ÅÆ firebaseConfig „Å´Êõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
        // =========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyCZxC2imSus21qmrN4OelItvq9pyGJm0sE",
          authDomain: "chiyoda-map-sns.firebaseapp.com",
          projectId: "chiyoda-map-sns",
          storageBucket: "chiyoda-map-sns.firebasestorage.app",
          messagingSenderId: "140311034396",
          appId: "1:140311034396:web:eff090822e46f6d5787dd9"
        };
        // =========================================================

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            var btn = document.getElementById('sidebar-toggle');
            if(sb.style.display === 'none') { sb.style.display = 'flex'; btn.innerText = '‚óÄ'; }
            else { sb.style.display = 'none'; btn.innerText = '‚ñ∂'; }
        }

        window.onload = function() {
            if (typeof L === 'undefined') { alert('Âú∞Âõ≥„Ç®„É©„Éº'); return; }
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(e=>{});

            var center = [35.685175, 139.752762];
            var map = L.map('mapid', { zoomControl: false }).setView(center, 14);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap', className: 'grayscale-tile' }).addTo(map);

            var worldLatLngs = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
            var chiyodaHole = [[35.706, 139.728], [35.706, 139.784], [35.668, 139.784], [35.668, 139.728]];
            L.polygon([worldLatLngs, chiyodaHole], { color: 'transparent', fillColor: '#000', fillOpacity: 0.6, interactive: false }).addTo(map);

            var markersMap = {};
            var hashtagStats = {};
            var topZIndex = 1000;
            var currentLocationMarker = null;
            var currentUser = null;
            var currentHandleName = ""; // ÁèæÂú®„ÅÆ„Éè„É≥„Éâ„É´„Éç„Éº„É†
            var unsubscribe = null;

            // Ë™çË®º & „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÂèñÂæó
            document.getElementById('login-btn').onclick = () => auth.signInWithPopup(provider).catch(e => alert(e.message));
            document.getElementById('logout-btn').onclick = () => auth.signOut();
            
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    // ‚òÖ „É≠„Ç∞„Ç§„É≥ÊôÇ: Firestore„Åã„Çâ„Éè„É≥„Éâ„É´„Éç„Éº„É†„ÇíÂèñÂæó
                    await checkUserProfile(user);
                    
                    document.getElementById('login-btn').style.display='none';
                    document.getElementById('user-info').style.display='flex';
                    document.getElementById('user-icon').src = user.photoURL;
                    document.getElementById('user-name').textContent = currentHandleName;
                } else {
                    document.getElementById('login-btn').style.display='block';
                    document.getElementById('user-info').style.display='none';
                    currentHandleName = "";
                }
                setupDataListener();
            });

            // ‚òÖ „Éè„É≥„Éâ„É´„Éç„Éº„É†„ÅÆÂèñÂæó„ÉªÂàùÊúüÂåñ
            async function checkUserProfile(user) {
                const userRef = db.collection('users').doc(user.uid);
                try {
                    const doc = await userRef.get();
                    if (doc.exists) {
                        // „Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰Ωø„ÅÜ
                        currentHandleName = doc.data().handleName;
                    } else {
                        // „Å™„Åë„Çå„Å∞Google„ÅÆÂêçÂâç„ÅßÂàùÊúüÂåñ„Åó„Å¶‰øùÂ≠ò
                        currentHandleName = user.displayName;
                        await userRef.set({
                            handleName: currentHandleName,
                            photoURL: user.photoURL,
                            updatedAt: new Date().toISOString()
                        });
                    }
                } catch(e) {
                    console.error("„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó„Ç®„É©„Éº", e);
                    currentHandleName = user.displayName; // „Ç®„É©„ÉºÊôÇ„ÅØ„Å®„Çä„ÅÇ„Åà„ÅöGoogleÂêç
                }
                document.getElementById('user-name').textContent = currentHandleName;
            }

            // ‚òÖ „Éè„É≥„Éâ„É´„Éç„Éº„É†Â§âÊõ¥„Éú„Çø„É≥
            document.getElementById('edit-name-btn').onclick = async function() {
                if(!currentUser) return;
                const newName = prompt("Êñ∞„Åó„ÅÑÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", currentHandleName);
                if(newName && newName.trim() !== "") {
                    try {
                        // Firestore„ÇíÊõ¥Êñ∞
                        await db.collection('users').doc(currentUser.uid).update({
                            handleName: newName
                        });
                        // „É≠„Éº„Ç´„É´„ÇÇÊõ¥Êñ∞
                        currentHandleName = newName;
                        document.getElementById('user-name').textContent = newName;
                    } catch(e) {
                        alert("ÂêçÂâç„ÅÆÂ§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + e.message);
                    }
                }
            };

            function setupDataListener() {
                if(unsubscribe) unsubscribe();
                unsubscribe = db.collection("posts").orderBy("date", "desc").onSnapshot((snapshot) => {
                    var loadingMsg = document.getElementById('loading-msg');
                    if (loadingMsg) loadingMsg.style.display = 'none';
                    
                    var list = document.getElementById('comment-list');
                    list.innerHTML = "";
                    hashtagStats = {};

                    snapshot.forEach((doc) => {
                        var data = doc.data();
                        var docId = doc.id;
                        var tags = data.text.match(/(#\S+)/g);
                        if(tags) tags.forEach(t => { hashtagStats[t] = (hashtagStats[t] || 0) + 1; });

                        if (!markersMap[docId]) {
                            var styledText = formatTextWithHashtags(data.text);
                            var customIcon = createCustomIcon(docId, styledText, data.likeCount, data.image);
                            var marker = L.marker([data.lat, data.lng], { icon: customIcon }).addTo(map);
                            markersMap[docId] = marker;
                        } else {
                            var marker = markersMap[docId];
                            var styledText = formatTextWithHashtags(data.text);
                            var newIcon = createCustomIcon(docId, styledText, data.likeCount, data.image);
                            marker.setIcon(newIcon);
                        }
                        addSidebarItem(docId, data, markersMap[docId]);
                    });
                    renderPopularHashtags();
                });
            }

            map.on('click', function(e) {
                if(e.originalEvent.target.id === 'gps-btn' || e.originalEvent.target.id === 'sidebar-toggle') return;
                var container = document.createElement('div');
                container.className = 'comment-form';
                if (!currentUser) {
                    container.innerHTML = `<div style="margin-bottom:10px; font-size:12px; color:red;">ÊäïÁ®ø„Åô„Çã„Å´„ÅØ<br>„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>`;
                } else {
                    // ÊäïÁ®ø„Éï„Ç©„Éº„É†„Å´ÁèæÂú®„ÅÆÂêçÂâç„ÇíË°®Á§∫
                    container.innerHTML = `<div style="margin-bottom:5px; font-size:12px;"><b>${currentHandleName}</b> „Å®„Åó„Å¶ÊäïÁ®ø</div>`;
                    var input = document.createElement('input'); input.type = "text"; input.placeholder = "„Ç≥„É°„É≥„Éà..."; input.className = 'comment-input'; container.appendChild(input);
                    var fileInput = document.createElement('input'); fileInput.type = "file"; fileInput.accept = "image/*"; fileInput.className = "file-input"; container.appendChild(fileInput);
                    var btn = document.createElement('button'); btn.innerText = "ÊäïÁ®ø"; btn.className = 'comment-btn';
                    btn.onclick = function() {
                        var text = input.value;
                        if(!text) { alert("ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
                        var file = fileInput.files[0];
                        if (file) {
                            if(file.size > 800 * 1024) { alert("ÁîªÂÉè„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô"); return; }
                            var reader = new FileReader();
                            reader.onload = function(evt) { submitToFirebase(e.latlng, text, evt.target.result); };
                            reader.readAsDataURL(file);
                        } else { submitToFirebase(e.latlng, text, null); }
                    };
                    container.appendChild(btn);
                }
                L.popup().setLatLng(e.latlng).setContent(container).openOn(map);
            });

            function submitToFirebase(latlng, text, imageData) {
                // ‚òÖ ÊäïÁ®øÊôÇ„Å´ currentHandleName „Çí‰Ωø„ÅÜ
                db.collection("posts").add({
                    lat: latlng.lat, lng: latlng.lng, text: text, image: imageData, likeCount: 0,
                    date: new Date().toISOString(), uid: currentUser.uid, 
                    authorName: currentHandleName, // „Åì„Åì„ÅåÂ§âÊõ¥ÁÇπ
                    authorPhoto: currentUser.photoURL
                }).then(() => map.closePopup()).catch(e => alert(e.message));
            }

            function addSidebarItem(docId, data, marker) {
                var list = document.getElementById('comment-list');
                var li = document.createElement('li');
                li.className = 'comment-item';
                if (currentUser && data.uid === currentUser.uid) li.classList.add('my-post');

                var thumbSrc = data.image ? data.image : (data.authorPhoto || 'https://placehold.co/40');
                var thumbDiv = document.createElement('img');
                thumbDiv.className = 'item-thumb';
                thumbDiv.src = thumbSrc;
                li.appendChild(thumbDiv);

                var contentDiv = document.createElement('div');
                contentDiv.className = 'item-content';
                
                var textSpan = document.createElement('span');
                textSpan.className = 'item-text';
                textSpan.innerHTML = formatTextWithHashtags(data.text);
                contentDiv.appendChild(textSpan);

                var metaDiv = document.createElement('div');
                metaDiv.className = 'item-meta';
                var timeStr = new Date(data.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                metaDiv.innerHTML = `<span>${data.authorName}</span> ‚Ä¢ <span>${timeStr}</span>`;
                contentDiv.appendChild(metaDiv);
                
                li.appendChild(contentDiv);

                var actionsDiv = document.createElement('div');
                actionsDiv.className = 'item-actions';

                var likeBtn = document.createElement('button');
                likeBtn.className = 'item-like-btn';
                if(data.likeCount > 0) {
                    likeBtn.innerHTML = `‚ù§Ô∏è ${data.likeCount}`;
                    likeBtn.classList.add('liked');
                } else { likeBtn.innerHTML = `ü§ç`; }
                likeBtn.onclick = function(e) {
                    e.stopPropagation();
                    db.collection("posts").doc(docId).update({ likeCount: (data.likeCount || 0) + 1 });
                };
                actionsDiv.appendChild(likeBtn);

                var delBtn = document.createElement('button');
                delBtn.className = 'item-delete-btn';
                delBtn.innerHTML = '&times;';
                delBtn.onclick = function(e) {
                    e.stopPropagation();
                    if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                        li.remove(); map.removeLayer(marker);
                        db.collection("posts").doc(docId).delete().catch(e => alert("ÂâäÈô§Â§±Êïó: " + e));
                    }
                };
                actionsDiv.appendChild(delBtn);
                li.appendChild(actionsDiv);

                li.onclick = function(e) {
                    if (e.target.closest('button')) return;
                    topZIndex++; marker.setZIndexOffset(topZIndex); map.panTo(marker.getLatLng());
                    var el = marker.getElement();
                    if(el) {
                        document.querySelectorAll('.highlight-pin').forEach(e=>e.classList.remove('highlight-pin'));
                        el.classList.add('highlight-pin');
                        document.querySelectorAll('.comment-item').forEach(e=>e.classList.remove('active'));
                        li.classList.add('active');
                    }
                };
                list.appendChild(li);
            }

            function createCustomIcon(id, text, likeCount, imageData) {
                var thumbHtml = imageData ? `<img src="${imageData}" class="pin-thumbnail">` : '';
                var likeHtml = likeCount > 0 ? ` <span style="color:#ff4081">‚ù§Ô∏è${likeCount}</span>` : '';
                var html = `<div class="custom-pin-container">${thumbHtml}<div class="custom-pin-bubble">${text}${likeHtml}</div><div class="custom-pin-dot"></div></div>`;
                return L.divIcon({ html: html, className: '', iconSize: [0, 0], iconAnchor: [0, 0] });
            }

            function formatTextWithHashtags(text) { return text.replace(/(#\S+)/g, '<span class="hashtag">$1</span>'); }

            function renderPopularHashtags() {
                var container = document.getElementById('hashtag-section');
                var sortedTags = Object.keys(hashtagStats).map(k => ({ tag: k, count: hashtagStats[k] })).sort((a,b) => b.count - a.count);
                if (sortedTags.length === 0) { container.innerHTML = "„Çø„Ç∞„Å™„Åó"; return; }
                container.innerHTML = "";
                sortedTags.slice(0, 10).forEach(i => {
                    var span = document.createElement('span');
                    span.className = 'popular-tag';
                    span.innerHTML = `${i.tag} ${i.count}`;
                    container.appendChild(span);
                });
            }

            document.getElementById('gps-btn').onclick = function() {
                if (!navigator.geolocation) return;
                this.innerText = "‚åõ";
                navigator.geolocation.getCurrentPosition(pos => {
                    var latlng = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(latlng, 16);
                    if (currentLocationMarker) currentLocationMarker.setLatLng(latlng);
                    else {
                        currentLocationMarker = L.circleMarker(latlng, { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                        L.circle(latlng, { radius: pos.coords.accuracy/2, color: 'transparent', fillColor: '#3388ff', fillOpacity: 0.2 }).addTo(map);
                    }
                    currentLocationMarker.bindPopup("ÁèæÂú®Âú∞").openPopup();
                    document.getElementById('gps-btn').innerText = "üìç";
                }, () => alert("‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº"));
            };
        };
    </script>
</body>
</html>