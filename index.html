<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂçÉ‰ª£Áî∞Âå∫„Ç≥„É°„É≥„Éà„Éû„ÉÉ„Éó</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', 
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>

    <style>
        body { overscroll-behavior: none; }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 260px !important; }
        .leaflet-container a.leaflet-popup-close-button { top: 8px; right: 8px; color: #333; background: rgba(255,255,255,0.8); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; z-index: 10; font-size: 14px; }
        
        /* --- „Éû„Éº„Ç´„Éº„Éá„Ç∂„Ç§„É≥ --- */
        .marker-container {
            position: relative;
            overflow: visible !important;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            filter: drop-shadow(0 3px 4px rgba(0,0,0,0.2));
            width: 140px; height: 100px; padding-bottom: 5px;
            /* ‚òÖÈáçË¶Å‚òÖ „Ç≥„É≥„ÉÜ„ÉäËá™‰Ωì„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÇíÈÄö„ÅôÔºàÂú∞Âõ≥Êìç‰Ωú„ÅÆÈÇ™È≠î„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ */
            pointer-events: none; 
        }

        .marker-bubble {
            position: relative; background: white; border-radius: 99px; padding: 4px 12px;
            font-size: 11px; font-weight: bold; color: #334155; white-space: nowrap;
            max-width: 100%; text-align: center; margin-bottom: 6px; z-index: 10;
            /* ‚òÖÈáçË¶Å‚òÖ Âêπ„ÅçÂá∫„Åó„ÇÇ„ÇØ„É™„ÉÉ„ÇØ„ÇíÈÄö„Åô */
            pointer-events: none;
        }
        .marker-bubble::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid white;
        }

        .marker-circle {
            position: relative; border-radius: 50%; z-index: 5; background-size: cover; background-position: center; transition: transform 0.2s;
            /* ‚òÖÈáçË¶Å‚òÖ „Éî„É≥Êú¨‰Ωì„Å†„Åë„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÇíÂèó„Åë‰ªò„Åë„Çã */
            pointer-events: auto; 
            cursor: pointer;
        }
        
        .no-image-pin { width: 20px; height: 20px; border: 2px solid white; }
        .has-image-pin { width: 44px; height: 44px; border: 3px solid white; background-color: white; }

        .highlight-pin { z-index: 9999 !important; }
        .highlight-pin .marker-circle { transform: scale(1.2); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); }
        .highlight-pin .marker-bubble { background-color: #eff6ff; color: #2563eb; }
        .highlight-pin .marker-bubble::after { border-top-color: #eff6ff; }

        .cropper-container { width: 100%; height: 100%; }
        
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        /* „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Âº∑Âåñ */
        .cat-radio:checked + .cat-label {
            opacity: 1; transform: scale(1.1); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            font-weight: bold;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-gray-50 text-slate-700 font-sans">

    <div id="container" class="flex flex-col md:flex-row h-full w-full relative">
        
        <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
        <div id="sidebar" class="w-full md:w-80 bg-white flex flex-col shadow-xl z-20 h-1/2 md:h-full order-2 md:order-1 transition-all duration-300">
            
            <!-- „É≠„Ç∞„Ç§„É≥„Ç®„É™„Ç¢ -->
            <div id="login-section" class="p-4 border-b border-gray-100">
                <button id="login-btn" class="w-full bg-slate-800 text-white font-bold py-2 px-4 rounded-full hover:bg-slate-700 transition shadow-sm flex items-center justify-center gap-2">
                    <i class="fab fa-google"></i> „É≠„Ç∞„Ç§„É≥„Åó„Å¶Âßã„ÇÅ„Çã
                </button>
                
                <div id="user-info" class="hidden items-center gap-3">
                    <label class="relative cursor-pointer group flex-shrink-0">
                        <img id="user-icon" src="" class="w-10 h-10 rounded-full object-cover border-2 border-gray-100 group-hover:border-primary transition">
                        <div class="absolute bottom-0 right-0 bg-primary text-white rounded-full w-4 h-4 flex items-center justify-center text-[8px] border border-white">
                            <i class="fas fa-pen"></i>
                        </div>
                        <button id="change-icon-btn" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"></button>
                    </label>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline gap-2">
                            <span id="user-name" class="font-bold text-sm truncate text-slate-800"></span>
                            <button id="edit-name-btn" class="text-xs text-slate-400 hover:text-primary"><i class="fas fa-pen"></i></button>
                        </div>
                    </div>
                    <button id="logout-btn" class="text-slate-400 hover:text-red-500 text-sm p-2"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <!-- „Éï„Ç£„É´„Çø & Êõ¥Êñ∞ -->
            <div id="filter-section" class="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center justify-between gap-2">
                <div class="relative flex-1">
                    <select id="sort-select" class="w-full appearance-none bg-white border border-gray-200 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-100 cursor-pointer">
                        <option value="newest">üïí Êñ∞ÁùÄÈ†Ü</option>
                        <option value="likes">‚ù§Ô∏è ‰∫∫Ê∞óÈ†Ü</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                        <i class="fas fa-chevron-down text-[10px]"></i>
                    </div>
                </div>
                <button id="refresh-btn" class="bg-white text-slate-500 border border-gray-200 hover:text-primary hover:border-primary p-1.5 rounded-lg transition" title="Êõ¥Êñ∞">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <span class="text-[10px] text-slate-400 font-medium whitespace-nowrap">
                    2ÊôÇÈñì‰ª•ÂÜÖ
                </span>
            </div>

            <!-- „Ç≥„É°„É≥„Éà„É™„Çπ„Éà -->
            <div id="sidebar-content" class="flex-1 overflow-y-auto">
                <ul id="comment-list" class="divide-y divide-gray-50">
                    <div id="loading-spinner" class="flex justify-center p-8">
                        <div class="loader ease-linear rounded-full border-2 border-gray-200 h-6 w-6"></div>
                    </div>
                </ul>
            </div>
        </div>

        <!-- Âú∞Âõ≥„Ç®„É™„Ç¢ -->
        <div id="mapid" class="flex-1 h-1/2 md:h-full bg-gray-100 relative order-1 md:order-2 z-10">
            <button id="sidebar-toggle" onclick="toggleSidebar()" class="hidden md:flex absolute top-4 left-4 z-[1000] bg-white text-slate-600 hover:text-primary w-10 h-10 rounded-xl shadow-lg items-center justify-center transition hover:scale-105">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button id="gps-btn" class="absolute bottom-6 right-6 z-[1000] bg-slate-800 text-white w-12 h-12 rounded-full shadow-xl flex items-center justify-center text-lg hover:bg-slate-700 transition hover:scale-110 active:scale-95">
                <i class="fas fa-location-arrow"></i>
            </button>
        </div>
    </div>

    <!-- ÁîªÂÉèÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="editor-modal" class="fixed inset-0 z-[10000] bg-black bg-opacity-90 hidden flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-lg bg-gray-900 rounded-lg overflow-hidden flex flex-col h-[70vh] shadow-2xl">
            <div class="flex-1 relative overflow-hidden flex items-center justify-center bg-black">
                <img id="editor-image" class="max-w-full max-h-full block" src="">
            </div>
            <div class="p-4 flex justify-between bg-white border-t border-gray-200">
                <button id="editor-cancel" class="text-gray-500 font-bold px-4 py-2 hover:bg-gray-100 rounded-lg transition">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="editor-save" class="bg-primary text-white font-bold px-6 py-2 rounded-lg hover:bg-blue-600 transition shadow-md">Ê±∫ÂÆö (400x400)</button>
            </div>
        </div>
    </div>

    <!-- ÁîªÂÉèÊã°Â§ßË°®Á§∫„É¢„Éº„ÉÄ„É´ (LightBox) -->
    <div id="image-viewer" class="fixed inset-0 z-[10001] bg-black bg-opacity-95 hidden flex items-center justify-center p-2" onclick="this.classList.add('hidden')">
        <img id="viewer-img" src="" class="max-w-full max-h-full rounded shadow-lg object-contain">
    </div>

    <input type="file" id="global-file-input" accept="image/*" class="hidden">

    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold opacity-0 pointer-events-none transition-all duration-300 z-[9999] translate-y-4">
        ÈÄöÁü•
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        // =========================================================
        // üî• ÈáçË¶Å: Ëá™ÂàÜ„ÅÆ firebaseConfig „Å´Êõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
        // =========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyCZxC2imSus21qmrN4OelItvq9pyGJm0sE",
          authDomain: "chiyoda-map-sns.firebaseapp.com",
          projectId: "chiyoda-map-sns",
          storageBucket: "chiyoda-map-sns.firebasestorage.app",
          messagingSenderId: "140311034396",
          appId: "1:140311034396:web:eff090822e46f6d5787dd9"
        };
        // =========================================================

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        let cropper = null;
        let onCropConfirm = null;

        function openImageEditor(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('editor-image');
                img.src = e.target.result;
                const modal = document.getElementById('editor-modal');
                modal.classList.remove('hidden');
                if (cropper) cropper.destroy();
                setTimeout(() => {
                    cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 1, background: false });
                }, 100);
                onCropConfirm = callback;
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('editor-cancel').onclick = () => {
            document.getElementById('editor-modal').classList.add('hidden');
            if (cropper) cropper.destroy();
            document.getElementById('global-file-input').value = '';
        };

        document.getElementById('editor-save').onclick = () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 400, height: 400, fillColor: '#fff', imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
            const base64 = canvas.toDataURL('image/jpeg', 0.85);
            if (onCropConfirm) onCropConfirm(base64);
            document.getElementById('editor-modal').classList.add('hidden');
            if (cropper) cropper.destroy();
            document.getElementById('global-file-input').value = '';
        };

        function selectImage(callback) {
            const input = document.getElementById('global-file-input');
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                openImageEditor(file, callback);
            };
            input.click();
        }

        // ÁîªÂÉèÊã°Â§ßË°®Á§∫
        function showImageViewer(src) {
            const viewer = document.getElementById('image-viewer');
            const img = document.getElementById('viewer-img');
            img.src = src;
            viewer.classList.remove('hidden');
        }

        function showToast(message, type = 'normal') {
            const toast = document.getElementById("toast");
            toast.innerHTML = type === 'success' ? `<i class="fas fa-check-circle mr-2 text-green-400"></i>${message}` : 
                              type === 'error' ? `<i class="fas fa-exclamation-circle mr-2 text-red-400"></i>${message}` : message;
            toast.classList.remove("opacity-0", "translate-y-4", "pointer-events-none");
            setTimeout(() => toast.classList.add("opacity-0", "translate-y-4", "pointer-events-none"), 3000);
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const btnIcon = document.querySelector('#sidebar-toggle i');
            if (sb.classList.contains('md:-ml-80')) {
                sb.classList.remove('md:-ml-80');
                btnIcon.className = 'fas fa-chevron-left';
            } else {
                sb.classList.add('md:-ml-80');
                btnIcon.className = 'fas fa-chevron-right';
            }
        }

        window.onload = function() {
            if (typeof L === 'undefined') { alert('Âú∞Âõ≥„Ç®„É©„Éº'); return; }
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(e=>{});

            var center = [35.685175, 139.752762];
            
            var southWest = L.latLng(35.660, 139.720);
            var northEast = L.latLng(35.715, 139.795);
            var bounds = L.latLngBounds(southWest, northEast);

            var map = L.map('mapid', { 
                zoomControl: false,
                maxBounds: bounds,       
                maxBoundsViscosity: 1.0, 
                minZoom: 13              
            }).setView(center, 14);
            
            L.control.zoom({ position: 'topright' }).addTo(map);
            
            var standard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' });
            var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '¬© CartoDB' });
            var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: '¬© Esri' });
            standard.addTo(map);
            L.control.layers({ "Ê®ôÊ∫ñ": standard, "„ÉÄ„Éº„ÇØ": dark, "Ëà™Á©∫ÂÜôÁúü": satellite }).addTo(map);

            var markersMap = {};
            var currentPostsData = []; 
            var currentLocationMarker = null;
            var currentUser = null;
            var userProfile = { name: "", photo: "" };
            var unsubscribe = null;
            var selectedDocId = null;

            document.getElementById('login-btn').onclick = () => auth.signInWithPopup(provider).catch(e => showToast(e.message, 'error'));
            document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => showToast("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü"));
            
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    await loadUserProfile(user);
                    document.getElementById('login-btn').classList.add('hidden');
                    document.getElementById('user-info').classList.remove('hidden');
                    document.getElementById('user-info').classList.add('flex');
                    updateProfileUI();
                } else {
                    document.getElementById('login-btn').classList.remove('hidden');
                    document.getElementById('user-info').classList.add('hidden');
                    document.getElementById('user-info').classList.remove('flex');
                    userProfile = { name: "", photo: "" };
                }
                setupDataListener();
            });

            async function loadUserProfile(user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    userProfile.name = data.handleName || user.displayName;
                    userProfile.photo = data.photoURL || user.photoURL;
                } else {
                    userProfile.name = user.displayName;
                    userProfile.photo = user.photoURL;
                    await db.collection('users').doc(user.uid).set({
                        handleName: userProfile.name, photoURL: userProfile.photo, updatedAt: new Date().toISOString()
                    });
                }
            }

            function updateProfileUI() {
                document.getElementById('user-name').textContent = userProfile.name;
                document.getElementById('user-icon').src = userProfile.photo;
            }

            document.getElementById('edit-name-btn').onclick = async function() {
                const newName = prompt("Êñ∞„Åó„ÅÑÂêçÂâç:", userProfile.name);
                if(newName && newName.trim()) {
                    await db.collection('users').doc(currentUser.uid).update({ handleName: newName });
                    userProfile.name = newName; updateProfileUI();
                    showToast("ÂêçÂâç„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü", 'success');
                }
            };

            document.getElementById('change-icon-btn').onclick = function() {
                selectImage(async (base64) => {
                    try {
                        await db.collection('users').doc(currentUser.uid).update({ photoURL: base64 });
                        userProfile.photo = base64; 
                        updateProfileUI();
                        showToast("„Ç¢„Ç§„Ç≥„É≥„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü", 'success');
                    } catch(err) { showToast("Êõ¥Êñ∞Â§±Êïó", 'error'); }
                });
            };

            document.getElementById('refresh-btn').onclick = function() {
                const btn = this;
                btn.classList.add('animate-spin');
                setupDataListener();
                setTimeout(() => btn.classList.remove('animate-spin'), 1000);
            };

            function setupDataListener() {
                if(unsubscribe) unsubscribe();
                unsubscribe = db.collection("posts").onSnapshot((snapshot) => {
                    const spinner = document.getElementById('loading-spinner');
                    if (spinner) spinner.style.display = 'none';
                    
                    currentPostsData = [];
                    snapshot.forEach(doc => {
                        currentPostsData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const currentIds = currentPostsData.map(p => p.id);
                    Object.keys(markersMap).forEach(id => {
                        if (!currentIds.includes(id)) {
                            map.removeLayer(markersMap[id]);
                            delete markersMap[id];
                        }
                    });

                    refreshUI(); 
                });
            }

            function createPopupContent(data, docId) {
                const div = document.createElement('div');
                div.className = "flex flex-col";
                
                // ÁîªÂÉè („ÇØ„É™„ÉÉ„ÇØ„ÅßÊã°Â§ß)
                if(data.image) {
                    const img = document.createElement('img');
                    img.src = data.image;
                    img.className = "w-16 h-16 object-cover rounded-lg bg-gray-100 cursor-pointer hover:opacity-90 border border-gray-200 mb-2";
                    img.title = "Êã°Â§ßË°®Á§∫";
                    // ‚òÖ ÁîªÂÉèÊã°Â§ß
                    img.onclick = () => showImageViewer(data.image);
                    div.appendChild(img);
                }

                const content = document.createElement('div');
                
                const header = document.createElement('div');
                header.className = "flex items-center gap-2 mb-2";
                const timeStr = new Date(data.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                header.innerHTML = `
                    <img src="${data.authorPhoto || 'https://placehold.co/20'}" class="w-6 h-6 rounded-full border border-gray-100">
                    <div class="flex flex-col leading-tight">
                        <span class="text-xs font-bold text-slate-800">${data.authorName}</span>
                        <span class="text-[10px] text-slate-400">${timeStr}</span>
                    </div>
                `;
                div.appendChild(header);

                const text = document.createElement('p');
                text.className = "text-sm text-slate-700 mb-3 break-words";
                text.innerHTML = formatTextWithHashtags(data.text);
                div.appendChild(text);

                const actions = document.createElement('div');
                actions.className = "flex items-center justify-between border-t pt-2 mt-1";
                
                const likeCount = data.likedBy ? data.likedBy.length : 0;
                const isLiked = currentUser && data.likedBy && data.likedBy.includes(currentUser.uid);
                
                const likeBtn = document.createElement('button');
                likeBtn.className = "flex items-center gap-1 text-slate-400 hover:text-pink-500 transition text-xs font-bold";
                likeBtn.innerHTML = `<i class="${isLiked ? 'fas' : 'far'} fa-heart ${isLiked ? 'text-pink-500' : ''}"></i> ${likeCount || '„ÅÑ„ÅÑ„Å≠'}`;
                likeBtn.onclick = () => {
                    if(!currentUser) return showToast("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ", 'error');
                    const ref = db.collection("posts").doc(docId);
                    if(isLiked) ref.update({ likedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                    else ref.update({ likedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                };
                actions.appendChild(likeBtn);

                const shareBtn = document.createElement('button');
                shareBtn.className = "text-slate-400 hover:text-primary transition text-xs";
                shareBtn.innerHTML = '<i class="fas fa-share-alt"></i>';
                shareBtn.onclick = () => {
                    const shareText = `„Äå${data.text}„Äç #ÂçÉ‰ª£Áî∞Âå∫„Éû„ÉÉ„Éó`;
                    if (navigator.share) navigator.share({ title: '„Éû„ÉÉ„Éó', text: shareText, url: window.location.href }).catch(()=>{});
                    else window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
                };
                actions.appendChild(shareBtn);

                if (currentUser && data.uid === currentUser.uid) {
                    const delBtn = document.createElement('button');
                    delBtn.className = "text-slate-300 hover:text-red-500 transition text-xs";
                    delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    delBtn.onclick = () => {
                        if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) db.collection("posts").doc(docId).delete().then(()=>showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü"));
                    };
                    actions.appendChild(delBtn);
                }

                div.appendChild(actions);
                return div;
            }

            function refreshUI() {
                const sortMode = document.getElementById('sort-select').value;
                const list = document.getElementById('comment-list');
                list.innerHTML = ""; 

                const now = new Date();
                const limitMs = 2 * 60 * 60 * 1000; 

                let filteredData = currentPostsData.filter(item => {
                    const date = new Date(item.date);
                    const diffMs = now - date;
                    return diffMs < limitMs;
                });

                filteredData.sort((a, b) => {
                    if (sortMode === 'newest') return new Date(b.date) - new Date(a.date);
                    else if (sortMode === 'likes') {
                        const likeA = a.likedBy ? a.likedBy.length : 0;
                        const likeB = b.likedBy ? b.likedBy.length : 0;
                        if (likeB !== likeA) return likeB - likeA;
                        return new Date(b.date) - new Date(a.date);
                    }
                });

                filteredData.forEach(data => {
                    const docId = data.id;
                    const likeCount = data.likedBy ? data.likedBy.length : 0;

                    if (!markersMap[docId]) {
                        const icon = createCustomIcon(data.text, data.image, data.category);
                        // ‚òÖ „Éî„É≥ÂÅ¥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Å®„Åç„ÅÆ„Åø„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈñã„Åè
                        // L.Marker„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅßÂÖ®‰Ωì„Åå„ÇØ„É™„ÉÉ„ÇØÂØæË±°„Å†„Åå„ÄÅCSS„Åß .marker-bubble „Çí pointer-events: none „Å´„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ
                        // Âêπ„ÅçÂá∫„ÅóÈÉ®ÂàÜ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅØÂú∞Âõ≥„Å´Êäú„Åë„ÄÅ„Éî„É≥Êú¨‰Ωì(circle)„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅÆ„Åø„Åå„Åì„Åì„Å´Êù•„Çã
                        const marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                        
                        marker.bindPopup(createPopupContent(data, docId));
                        marker.on('popupopen', () => selectPost(docId));
                        markersMap[docId] = marker;
                    } else {
                        const marker = markersMap[docId];
                        marker.setIcon(createCustomIcon(data.text, data.image, data.category));
                        if(marker.getPopup() && marker.getPopup().isOpen()) {
                            marker.setPopupContent(createPopupContent(data, docId));
                        } else {
                            marker.bindPopup(createPopupContent(data, docId));
                        }
                    }

                    const marker = markersMap[docId];
                    if (docId === selectedDocId) {
                        marker.setZIndexOffset(100000);
                        setTimeout(() => { if(marker.getElement()) marker.getElement().classList.add('highlight-pin'); }, 0);
                    } else {
                        marker.setZIndexOffset(likeCount * 100);
                        if(marker.getElement()) marker.getElement().classList.remove('highlight-pin');
                    }

                    addSidebarItem(docId, data);
                });
            }

            function selectPost(docId) {
                selectedDocId = docId;
                const listItem = document.getElementById('post-' + docId);
                if (listItem) {
                    document.querySelectorAll('.comment-item').forEach(el => el.classList.remove('bg-blue-50', 'border-l-4', 'border-primary'));
                    listItem.classList.add('bg-blue-50', 'border-l-4', 'border-primary');
                    listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                Object.keys(markersMap).forEach(id => {
                    const m = markersMap[id];
                    if(id === docId) {
                        m.setZIndexOffset(100000);
                        if(m.getElement()) m.getElement().classList.add('highlight-pin');
                    } else {
                        if(m.getElement()) m.getElement().classList.remove('highlight-pin');
                    }
                });
            }

            document.getElementById('sort-select').onchange = refreshUI;

            map.on('click', function(e) {
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇÑ„Éú„Çø„É≥‰ª•Â§ñÔºàÔºùÂú∞Âõ≥ËÉåÊôØÔºâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÅÆ„ÅøÊäïÁ®ø„Éï„Ç©„Éº„É†„ÇíÂá∫„Åô
                if(e.originalEvent.target.closest('button') || e.originalEvent.target.closest('.leaflet-popup-content') || e.originalEvent.target.closest('.leaflet-marker-icon')) return;
                
                selectedDocId = null;
                document.querySelectorAll('.highlight-pin').forEach(el => el.classList.remove('highlight-pin'));
                document.querySelectorAll('.comment-item').forEach(el => el.classList.remove('bg-blue-50', 'border-l-4', 'border-primary'));
                
                const container = document.createElement('div');
                container.className = 'w-64 text-center p-1';
                
                if (!currentUser) {
                    container.innerHTML = `<div class="text-xs text-red-500 mb-2 font-bold">ÊäïÁ®ø„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</div>`;
                } else {
                    container.innerHTML = `
                        <div class="text-xs text-slate-500 mb-3 text-left font-medium"><b>${userProfile.name}</b> „Å®„Åó„Å¶ÊäïÁ®ø</div>
                        <div class="flex justify-between mb-3 px-1 gap-1">
                            <label class="cursor-pointer p-2 rounded-lg bg-orange-50 hover:bg-orange-100 border border-orange-200 has-checked:bg-orange-200 has-checked:border-orange-400 flex-1 transition flex items-center justify-center">
                                <input type="radio" name="cat" value="gourmet" class="hidden cat-radio">
                                <span class="text-lg cat-label"><i class="fas fa-utensils text-orange-500"></i></span>
                            </label>
                            <label class="cursor-pointer p-2 rounded-lg bg-green-50 hover:bg-green-100 border border-green-200 has-checked:bg-green-200 has-checked:border-green-400 flex-1 transition flex items-center justify-center">
                                <input type="radio" name="cat" value="view" class="hidden cat-radio">
                                <span class="text-lg cat-label"><i class="fas fa-mountain-sun text-green-600"></i></span>
                            </label>
                            <label class="cursor-pointer p-2 rounded-lg bg-purple-50 hover:bg-purple-100 border border-purple-200 has-checked:bg-purple-200 has-checked:border-purple-400 flex-1 transition flex items-center justify-center">
                                <input type="radio" name="cat" value="event" class="hidden cat-radio">
                                <span class="text-lg cat-label"><i class="fas fa-calendar-check text-purple-500"></i></span>
                            </label>
                            <label class="cursor-pointer p-2 rounded-lg bg-blue-50 hover:bg-blue-100 border border-blue-200 has-checked:bg-blue-200 has-checked:border-blue-400 flex-1 transition flex items-center justify-center">
                                <input type="radio" name="cat" value="other" class="hidden cat-radio" checked>
                                <span class="text-lg cat-label"><i class="fas fa-comment-dots text-blue-500"></i></span>
                            </label>
                        </div>
                        <style>.has-checked:has(:checked) { transform: scale(1.05); box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-color: rgba(255,255,255,0.8); }</style>
                        <input type="text" id="post-text" class="w-full p-2 mb-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary" placeholder="„Ç≥„É°„É≥„Éà(30ÊñáÂ≠ó‰ª•ÂÜÖ)..." maxlength="30">
                        
                        <div id="image-preview-container" class="hidden mb-3 relative group">
                            <img id="image-preview" src="" class="w-full h-32 object-cover rounded-lg border border-slate-200">
                            <button id="remove-image-btn" class="absolute top-1 right-1 bg-black bg-opacity-50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-500 transition">‚úï</button>
                        </div>

                        <div class="flex justify-between items-center">
                            <button id="select-image-btn" class="text-slate-400 hover:text-primary text-xl p-2 transition"><i class="fas fa-camera"></i></button>
                            <button id="submit-post" class="bg-primary text-white text-xs font-bold py-2 px-6 rounded-full shadow-md hover:bg-blue-600 transition active:scale-95">ÊäïÁ®ø</button>
                        </div>
                    `;
                }
                L.popup().setLatLng(e.latlng).setContent(container).openOn(map);

                setTimeout(() => {
                    if(!currentUser) return;
                    let selectedImageBase64 = null;
                    const previewContainer = document.getElementById('image-preview-container');
                    const previewImg = document.getElementById('image-preview');
                    
                    document.getElementById('select-image-btn').onclick = () => {
                        selectImage((base64) => {
                            selectedImageBase64 = base64;
                            previewImg.src = base64;
                            previewContainer.classList.remove('hidden');
                            document.getElementById('select-image-btn').classList.add('text-green-500');
                        });
                    };

                    document.getElementById('remove-image-btn').onclick = () => {
                        selectedImageBase64 = null;
                        previewContainer.classList.add('hidden');
                        document.getElementById('select-image-btn').classList.remove('text-green-500');
                    };

                    document.getElementById('submit-post').onclick = () => {
                        const text = document.getElementById('post-text').value;
                        const category = document.querySelector('input[name="cat"]:checked').value;
                        
                        if(!text) return showToast("„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", 'error');
                        submitPost(e.latlng, text, selectedImageBase64, category);
                    };
                }, 100);
            });

            function submitPost(latlng, text, imageData, category) {
                db.collection("posts").add({
                    lat: latlng.lat, lng: latlng.lng, text: text, image: imageData, category: category,
                    date: new Date().toISOString(), uid: currentUser.uid,
                    authorName: userProfile.name, authorPhoto: userProfile.photo, likedBy: []
                }).then(() => {
                    map.closePopup();
                    showToast("ÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ", 'success');
                }).catch(e => showToast(e.message, 'error'));
            }

            function addSidebarItem(docId, data) {
                const list = document.getElementById('comment-list');
                const li = document.createElement('li');
                li.className = 'group flex items-start p-4 hover:bg-gray-50 cursor-pointer transition border-l-4 border-transparent';
                li.id = 'post-' + docId;
                
                if (docId === selectedDocId) li.classList.add('bg-blue-50', 'border-primary');
                
                const catColors = { gourmet: 'border-orange-400', view: 'border-green-500', event: 'border-purple-500', other: 'border-blue-500' };
                if (docId !== selectedDocId && data.category) li.classList.add(catColors[data.category] || 'border-blue-500');

                const avatar = document.createElement('img');
                avatar.className = 'w-10 h-10 rounded-full mr-3 object-cover bg-gray-200 flex-shrink-0 border border-gray-100';
                avatar.src = data.authorPhoto || 'https://placehold.co/40';
                li.appendChild(avatar);

                const body = document.createElement('div');
                body.className = 'flex-1 min-w-0 mr-3';
                
                const header = document.createElement('div');
                header.className = 'flex items-center gap-2 mb-1';
                const timeStr = new Date(data.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                header.innerHTML = `<span class="font-bold text-sm text-slate-800 truncate">${data.authorName}</span> <span class="text-xs text-slate-400">${timeStr}</span>`;
                body.appendChild(header);

                const textDiv = document.createElement('div');
                textDiv.className = 'text-sm text-slate-600 leading-snug break-words';
                textDiv.innerHTML = formatTextWithHashtags(data.text);
                body.appendChild(textDiv);

                const footer = document.createElement('div');
                footer.className = 'flex items-center gap-4 mt-2';
                
                const likeBtn = document.createElement('button');
                likeBtn.className = 'flex items-center gap-1 text-xs text-slate-400 hover:text-pink-500 transition group/like';
                const likeCount = data.likedBy ? data.likedBy.length : 0;
                const isLiked = currentUser && data.likedBy && data.likedBy.includes(currentUser.uid);
                likeBtn.innerHTML = `<i class="${isLiked ? 'fas' : 'far'} fa-heart text-sm ${isLiked ? 'text-pink-500' : ''}"></i> <span>${likeCount || ''}</span>`;
                likeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(!currentUser) return showToast("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ", 'error');
                    const postRef = db.collection("posts").doc(docId);
                    if (isLiked) postRef.update({ likedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                    else postRef.update({ likedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                };
                footer.appendChild(likeBtn);

                const shareBtn = document.createElement('button');
                shareBtn.className = 'text-slate-400 hover:text-primary transition text-xs';
                shareBtn.innerHTML = '<i class="fas fa-share-alt"></i>';
                shareBtn.onclick = (e) => {
                    e.stopPropagation();
                    const shareText = `„Äå${data.text}„Äç #ÂçÉ‰ª£Áî∞Âå∫„Éû„ÉÉ„Éó`;
                    if (navigator.share) navigator.share({ title: '„Éû„ÉÉ„Éó', text: shareText, url: window.location.href }).catch(()=>{});
                    else window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
                };
                footer.appendChild(shareBtn);

                if (currentUser && data.uid === currentUser.uid) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'text-slate-300 hover:text-red-500 transition text-xs ml-auto opacity-0 group-hover:opacity-100';
                    delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) db.collection("posts").doc(docId).delete().then(()=>showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü"));
                    };
                    footer.appendChild(delBtn);
                }
                
                body.appendChild(footer);
                li.appendChild(body);

                if (data.image) {
                    const thumb = document.createElement('img');
                    thumb.className = 'w-16 h-16 rounded-lg object-cover border border-gray-100 bg-gray-50 flex-shrink-0 cursor-pointer hover:opacity-80';
                    thumb.src = data.image;
                    // „É™„Çπ„Éà„ÅÆÁîªÂÉè„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÊã°Â§ß
                    thumb.onclick = (e) => {
                        e.stopPropagation();
                        showImageViewer(data.image);
                    };
                    li.appendChild(thumb);
                }

                li.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    selectPost(docId);
                    const marker = markersMap[docId];
                    if(marker) marker.openPopup();
                };
                list.appendChild(li);
            }

            function createCustomIcon(text, image, category) {
                if(text.length > 10) text = text.substring(0, 10) + "...";
                
                const colors = { gourmet: '#fb923c', view: '#4ade80', event: '#c084fc', other: '#3b82f6' };
                const color = colors[category] || colors.other;

                let circleClass, circleStyle;
                if (image) {
                    circleClass = 'has-image-pin';
                    circleStyle = `background-image: url('${image}');`;
                } else {
                    circleClass = 'no-image-pin';
                    circleStyle = `background-color: ${color};`;
                }

                const html = `
                    <div class="marker-container">
                        <div class="marker-bubble">${text}</div>
                        <div class="marker-circle ${circleClass}" style="${circleStyle}"></div>
                    </div>`;
                
                return L.divIcon({ html: html, className: '', iconSize: [140, 100], iconAnchor: [70, 95] });
            }

            function formatTextWithHashtags(text) { 
                return text ? text.replace(/(#\S+)/g, '<span class="text-primary font-medium mr-1">$1</span>') : ""; 
            }

            document.getElementById('gps-btn').onclick = function() {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(pos => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(latlng, 16);
                    if (currentLocationMarker) currentLocationMarker.setLatLng(latlng);
                    else {
                        currentLocationMarker = L.circleMarker(latlng, { radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 3, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                    }
                    currentLocationMarker.bindPopup("ÁèæÂú®Âú∞").openPopup();
                });
            };
        };
    </script>
</body>
</html>