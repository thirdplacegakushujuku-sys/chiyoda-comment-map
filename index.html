<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂçÉ‰ª£Áî∞Âå∫„Ç≥„É°„É≥„Éà„Éû„ÉÉ„Éó</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        body { margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color: #333; background: #fff; }
        #container { display: flex; height: 100vh; width: 100vw; flex-direction: row; }

        /* --- „Çµ„Ç§„Éâ„Éê„Éº --- */
        #sidebar {
            width: 340px; background-color: #fff; border-right: 1px solid #eee;
            display: flex; flex-direction: column; z-index: 2000;
            box-shadow: 4px 0 16px rgba(0,0,0,0.05); position: relative;
        }
        #mapid { flex: 1; height: 100%; background-color: #f8f9fa; position: relative; }

        @media (max-width: 600px) {
            #container { flex-direction: column; }
            #mapid { height: 60%; width: 100%; order: 1; }
            #sidebar { width: 100%; height: 40%; border-right: none; border-top: 1px solid #eee; order: 2; border-radius: 20px 20px 0 0; margin-top: -20px; z-index: 3000; box-shadow: 0 -4px 16px rgba(0,0,0,0.1); }
            #sidebar-toggle { display: none; }
        }

        /* --- Âú∞Âõ≥‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Éá„Ç∂„Ç§„É≥Ôºà„Çπ„Çø„Ç§„É™„ÉÉ„Ç∑„É•ÂåñÔºâ --- */
        .marker-container {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            position: relative; overflow: visible; width: 120px;
            /* ÂÖ®‰Ωì„ÅÆÂΩ± */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Âêπ„ÅçÂá∫„Åó */
        .marker-bubble {
            background-color: #fff;
            border-radius: 12px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 700;
            color: #444;
            max-width: 140px;
            position: relative;
            text-align: center;
            margin-bottom: 8px;
            overflow: visible !important;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .marker-content {
            display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
        }
        .marker-bubble::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; margin-left: -5px;
            border-width: 5px 5px 0; border-style: solid;
            border-color: #fff transparent transparent transparent;
            display: block;
        }

        /* „Éî„É≥Êú¨‰ΩìÔºàÂÖ±ÈÄöÔºâ */
        .marker-circle {
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        /* ÁîªÂÉè„ÅÇ„Çä„Éî„É≥ */
        .marker-circle.has-image {
            width: 44px; height: 44px;
            border: 3px solid #fff;
            background-color: #fff;
        }

        /* ÁîªÂÉè„Å™„Åó„Éî„É≥Ôºà„Çπ„Çø„Ç§„É™„ÉÉ„Ç∑„É•„Å™Èùí‰∏∏Ôºâ */
        .marker-circle.no-image {
            width: 20px; height: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3); /* „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
            border: 3px solid #fff;
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.3); /* ÂÜÖÂÅ¥„ÅÆÂÖâ */
        }
        
        /* --- ÈÅ∏ÊäûÁä∂ÊÖãÔºà„ÇØ„É™„ÉÉ„ÇØÊôÇÔºâ --- */
        .highlight-pin {
            z-index: 99999 !important; /* ÊúÄÂâçÈù¢„Å∏ */
        }
        .highlight-pin .marker-container {
            transform: scale(1.15) translateY(-5px); /* „Åµ„Çè„Å£„Å®ÊµÆ„Åç‰∏ä„Åå„Çã */
        }
        .highlight-pin .marker-circle {
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.3); /* Èùí„ÅÑÂÖâÂΩ© */
            border-color: #fff;
        }
        .highlight-pin .marker-circle.no-image {
            background: linear-gradient(135deg, #0062cc, #004494);
        }
        .highlight-pin .marker-bubble {
            color: #007bff;
            border-color: rgba(0, 123, 255, 0.2);
        }


        /* --- „Åù„ÅÆ‰ªñUI --- */
        #sidebar-toggle {
            position: absolute; top: 12px; left: 12px; z-index: 1000;
            background-color: white; border: 1px solid rgba(0,0,0,0.1); color: #555;
            border-radius: 8px; padding: 8px 12px; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        #sidebar-toggle:hover { background-color: #f8f9fa; }

        #gps-btn {
            position: absolute; bottom: 24px; right: 24px; z-index: 1000;
            background-color: white; border: none; border-radius: 50%;
            width: 48px; height: 48px; cursor: pointer; color: #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: transform 0.2s;
        }
        #gps-btn:active { transform: scale(0.95); }

        /* „É≠„Ç∞„Ç§„É≥„Ç®„É™„Ç¢ */
        #login-section { padding: 16px; border-bottom: 1px solid #f0f0f0; }
        #user-info { display: none; align-items: center; gap: 12px; }
        .user-icon-wrapper { position: relative; cursor: pointer; }
        #user-icon { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid #f0f0f0; }
        .icon-edit-overlay { position: absolute; bottom: -2px; right: -2px; background: #007bff; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        #user-details { flex: 1; overflow: hidden; }
        #user-name { font-weight: 800; font-size: 15px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #1a1a1a; }
        .edit-btn { background: none; border: none; color: #007bff; font-size: 11px; cursor: pointer; padding: 0; font-weight: 600; }
        .auth-btn { width: 100%; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; transition: opacity 0.2s; }
        .auth-btn:active { opacity: 0.8; }
        .btn-login { background-color: #007bff; color: white; }
        .btn-logout { background-color: #f1f3f5; color: #495057; width: auto; font-size: 11px; padding: 6px 12px; border-radius: 20px; }

        /* „Éï„Ç£„É´„Çø„Ç®„É™„Ç¢ */
        #filter-section { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; background: #fff; display: flex; gap: 10px; align-items: center; }
        .sort-select { padding: 6px 10px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 12px; background: #f8f9fa; color: #495057; font-weight: 600; flex: 1; cursor: pointer; }
        
        #sidebar-content { flex: 1; overflow-y: auto; padding: 0; -webkit-overflow-scrolling: touch; }

        /* „Ç≥„É°„É≥„Éà„É™„Çπ„Éà */
        #comment-list { list-style: none; padding: 0; margin: 0; }
        .comment-item { display: flex; align-items: flex-start; padding: 14px 16px; border-bottom: 1px solid #f8f9fa; cursor: pointer; transition: background 0.2s; }
        .comment-item:hover { background-color: #f8f9fa; }
        .comment-item.active { background-color: #f0f7ff; box-shadow: inset 4px 0 0 #007bff; }
        .item-avatar { width: 36px; height: 36px; border-radius: 50%; margin-right: 12px; object-fit: cover; background: #f1f3f5; flex-shrink: 0; }
        .item-body { flex: 1; min-width: 0; margin-right: 10px; }
        .item-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .item-author { font-weight: 700; font-size: 13px; color: #212529; }
        .item-time { font-size: 11px; color: #adb5bd; }
        .item-text { font-size: 13px; color: #495057; line-height: 1.5; word-wrap: break-word; }
        .item-footer { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        
        .item-like-btn { background: none; border: none; cursor: pointer; color: #adb5bd; font-size: 13px; padding: 0; display: flex; align-items: center; gap: 4px; transition: color 0.2s; }
        .item-like-btn:hover, .item-like-btn.liked { color: #ff6b6b; }
        
        .item-delete-btn { color: #dee2e6; cursor: pointer; font-size: 12px; display: none; transition: color 0.2s; }
        .item-delete-btn:hover { color: #fa5252; }
        .my-post .item-delete-btn { display: inline-block; }
        .item-right-img { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; border: 1px solid #f1f3f5; background: #f8f9fa; flex-shrink: 0; }
        
        .hashtag { color: #007bff; margin-right: 2px; }
        
        /* ÊäïÁ®ø„Éï„Ç©„Éº„É† */
        .comment-form { text-align: center; width: 240px; padding: 8px; }
        .form-header { font-size: 12px; color: #868e96; margin-bottom: 12px; text-align: left; font-weight: 500; }
        .comment-input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; font-size: 14px; -webkit-appearance: none; }
        .form-actions { display: flex; justify-content: space-between; align-items: center; }
        .image-upload-label { cursor: pointer; color: #007bff; font-size: 20px; padding: 8px; transition: opacity 0.2s; }
        .image-upload-label:active { opacity: 0.6; }
        .image-upload-label.has-file { color: #20c997; }
        #post-file-input, #avatar-upload-input { display: none; }
        .comment-btn { padding: 8px 24px; background: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 700; font-size: 13px; box-shadow: 0 2px 6px rgba(0,123,255,0.3); transition: all 0.2s; }
        .comment-btn:active { transform: scale(0.96); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 24px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="container">
        <div id="sidebar">
            <!-- „É≠„Ç∞„Ç§„É≥„Ç®„É™„Ç¢ -->
            <div id="login-section">
                <button id="login-btn" class="auth-btn btn-login">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                
                <div id="user-info">
                    <label for="avatar-upload-input" class="user-icon-wrapper" title="„Ç¢„Ç§„Ç≥„É≥„ÇíÂ§âÊõ¥">
                        <img id="user-icon" src="" alt="icon">
                        <div class="icon-edit-overlay"><i class="fas fa-camera"></i></div>
                    </label>
                    <input type="file" id="avatar-upload-input" accept="image/*">
                    <div id="user-details">
                        <span id="user-name"></span>
                        <button id="edit-name-btn" class="edit-btn">ÂêçÂâç„ÇíÂ§âÊõ¥</button>
                    </div>
                    <button id="logout-btn" class="auth-btn btn-logout">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>

            <!-- „Éï„Ç£„É´„Çø„Éª„ÇΩ„Éº„Éà -->
            <div id="filter-section">
                <select id="sort-select" class="sort-select">
                    <option value="newest">üïí Êñ∞ÁùÄÈ†Ü</option>
                    <option value="likes">‚ù§Ô∏è „ÅÑ„ÅÑ„Å≠È†Ü</option>
                </select>
                <div style="font-size: 10px; color: #adb5bd; margin-left: 10px; font-weight: 500;">‚Äª2ÊôÇÈñì‰ª•ÂÜÖ„ÇíË°®Á§∫</div>
            </div>

            <div id="sidebar-content">
                <ul id="comment-list"><div id="loading-spinner" class="loader"></div></ul>
            </div>
        </div>
        <div id="mapid">
            <button id="sidebar-toggle" onclick="toggleSidebar()">‚óÄ</button>
            <button id="gps-btn" title="ÁèæÂú®Âú∞„Å∏"><i class="fas fa-location-arrow"></i></button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        // =========================================================
        // üî• ÈáçË¶Å: Ëá™ÂàÜ„ÅÆ firebaseConfig „Å´Êõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
        // =========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyCZxC2imSus21qmrN4OelItvq9pyGJm0sE",
          authDomain: "chiyoda-map-sns.firebaseapp.com",
          projectId: "chiyoda-map-sns",
          storageBucket: "chiyoda-map-sns.firebasestorage.app",
          messagingSenderId: "140311034396",
          appId: "1:140311034396:web:eff090822e46f6d5787dd9"
        };
        // =========================================================

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            var btn = document.getElementById('sidebar-toggle');
            if(sb.style.display === 'none') { sb.style.display = 'flex'; btn.innerText = '‚óÄ'; }
            else { sb.style.display = 'none'; btn.innerText = '‚ñ∂'; }
        }

        window.onload = function() {
            if (typeof L === 'undefined') { alert('Âú∞Âõ≥„Ç®„É©„Éº'); return; }
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(e=>{});

            var center = [35.685175, 139.752762];
            var map = L.map('mapid', { zoomControl: false }).setView(center, 14);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap', className: '' }).addTo(map);

            var markersMap = {};
            var currentPostsData = []; 
            var currentLocationMarker = null;
            var currentUser = null;
            var userProfile = { name: "", photo: "" };
            var unsubscribe = null;
            var selectedDocId = null; // ‚òÖËøΩÂä†: ÈÅ∏Êäû‰∏≠„ÅÆ„Éû„Éº„Ç´„ÉºID

            document.getElementById('login-btn').onclick = () => auth.signInWithPopup(provider).catch(e => alert(e.message));
            document.getElementById('logout-btn').onclick = () => auth.signOut();
            
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    await loadUserProfile(user);
                    document.getElementById('login-btn').style.display='none';
                    document.getElementById('user-info').style.display='flex';
                    updateProfileUI();
                } else {
                    document.getElementById('login-btn').style.display='block';
                    document.getElementById('user-info').style.display='none';
                    userProfile = { name: "", photo: "" };
                }
                setupDataListener();
            });

            async function loadUserProfile(user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    userProfile.name = data.handleName || user.displayName;
                    userProfile.photo = data.photoURL || user.photoURL;
                } else {
                    userProfile.name = user.displayName;
                    userProfile.photo = user.photoURL;
                    await db.collection('users').doc(user.uid).set({
                        handleName: userProfile.name, photoURL: userProfile.photo, updatedAt: new Date().toISOString()
                    });
                }
            }

            function updateProfileUI() {
                document.getElementById('user-name').textContent = userProfile.name;
                document.getElementById('user-icon').src = userProfile.photo;
            }

            document.getElementById('edit-name-btn').onclick = async function() {
                const newName = prompt("Êñ∞„Åó„ÅÑÂêçÂâç:", userProfile.name);
                if(newName && newName.trim()) {
                    await db.collection('users').doc(currentUser.uid).update({ handleName: newName });
                    userProfile.name = newName; updateProfileUI();
                }
            };

            document.getElementById('avatar-upload-input').onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 500 * 1024) { alert("ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô(500KB‰ª•‰∏ãÊé®Â•®)"); return; }
                const reader = new FileReader();
                reader.onload = async function(evt) {
                    const base64 = evt.target.result;
                    try {
                        await db.collection('users').doc(currentUser.uid).update({ photoURL: base64 });
                        userProfile.photo = base64; updateProfileUI();
                    } catch(err) { alert("Êõ¥Êñ∞Â§±Êïó: " + err.message); }
                };
                reader.readAsDataURL(file);
            };

            function setupDataListener() {
                if(unsubscribe) unsubscribe();
                unsubscribe = db.collection("posts").onSnapshot((snapshot) => {
                    const spinner = document.getElementById('loading-spinner');
                    if (spinner) spinner.style.display = 'none';
                    
                    currentPostsData = [];
                    snapshot.forEach(doc => {
                        currentPostsData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const currentIds = currentPostsData.map(p => p.id);
                    Object.keys(markersMap).forEach(id => {
                        if (!currentIds.includes(id)) {
                            map.removeLayer(markersMap[id]);
                            delete markersMap[id];
                        }
                    });

                    refreshUI(); 
                });
            }

            function refreshUI() {
                const sortMode = document.getElementById('sort-select').value;
                const list = document.getElementById('comment-list');
                list.innerHTML = ""; 

                const now = new Date();
                const limitMs = 2 * 60 * 60 * 1000; 

                let filteredData = currentPostsData.filter(item => {
                    const date = new Date(item.date);
                    const diffMs = now - date;
                    return diffMs < limitMs;
                });

                filteredData.sort((a, b) => {
                    if (sortMode === 'newest') return new Date(b.date) - new Date(a.date);
                    else if (sortMode === 'likes') {
                        const likeA = a.likedBy ? a.likedBy.length : 0;
                        const likeB = b.likedBy ? b.likedBy.length : 0;
                        if (likeB !== likeA) return likeB - likeA;
                        return new Date(b.date) - new Date(a.date);
                    }
                });

                filteredData.forEach(data => {
                    const docId = data.id;
                    const likeCount = data.likedBy ? data.likedBy.length : 0;

                    if (!markersMap[docId]) {
                        const icon = createCustomIcon(data.text, data.image);
                        const marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                        markersMap[docId] = marker;
                    } else {
                        const marker = markersMap[docId];
                        marker.setIcon(createCustomIcon(data.text, data.image));
                    }

                    // ‚òÖ Z-indexÂà∂Âæ°„ÅÆÂº∑Âåñ
                    const marker = markersMap[docId];
                    if (docId === selectedDocId) {
                        marker.setZIndexOffset(100000); // ÈÅ∏Êäû‰∏≠„ÅØÊúÄÂº∑
                        // ÈÅ∏Êäû‰∏≠„Çπ„Çø„Ç§„É´„ÅÆÈÅ©Áî®Ôºà„É™„Éï„É¨„ÉÉ„Ç∑„É•ÊôÇ„ÇÇÁ∂≠ÊåÅÔºâ
                        setTimeout(() => {
                            if(marker.getElement()) marker.getElement().classList.add('highlight-pin');
                        }, 0);
                    } else {
                        marker.setZIndexOffset(likeCount * 100);
                        if(marker.getElement()) marker.getElement().classList.remove('highlight-pin');
                    }

                    addSidebarItem(docId, data, markersMap[docId]);
                });
            }

            document.getElementById('sort-select').onchange = refreshUI;

            map.on('click', function(e) {
                if(e.originalEvent.target.closest('button')) return;
                
                // Âú∞Âõ≥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈÅ∏ÊäûËß£Èô§
                selectedDocId = null;
                document.querySelectorAll('.highlight-pin').forEach(el => el.classList.remove('highlight-pin'));
                document.querySelectorAll('.comment-item').forEach(el => el.classList.remove('active'));
                refreshUI(); // Z-index„ÇíÊàª„Åô„Åü„ÇÅ

                const container = document.createElement('div');
                container.className = 'comment-form';
                
                if (!currentUser) {
                    container.innerHTML = `<div style="font-size:12px;color:red;margin-bottom:10px;">ÊäïÁ®ø„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</div>`;
                } else {
                    container.innerHTML = `
                        <div class="form-header"><b>${userProfile.name}</b> „Å®„Åó„Å¶ÊäïÁ®ø</div>
                        <input type="text" id="post-text" class="comment-input" placeholder="„Ç≥„É°„É≥„Éà...">
                        <div class="form-actions">
                            <label for="post-file-input" class="image-upload-label" id="file-label"><i class="fas fa-camera"></i></label>
                            <!-- ‚òÖ captureÂ±ûÊÄß„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü -->
                            <input type="file" id="post-file-input" accept="image/*">
                            <button id="submit-post" class="comment-btn">ÊäïÁ®ø</button>
                        </div>
                    `;
                }
                L.popup().setLatLng(e.latlng).setContent(container).openOn(map);

                setTimeout(() => {
                    if(!currentUser) return;
                    const fileInput = document.getElementById('post-file-input');
                    const label = document.getElementById('file-label');
                    const btn = document.getElementById('submit-post');
                    
                    fileInput.onchange = () => {
                        if(fileInput.files.length > 0) label.classList.add('has-file');
                        else label.classList.remove('has-file');
                    };

                    btn.onclick = () => {
                        const text = document.getElementById('post-text').value;
                        if(!text) return alert("„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                        
                        const file = fileInput.files[0];
                        if (file) {
                            if (file.size > 800 * 1024) return alert("ÁîªÂÉè„Çµ„Ç§„Ç∫ÈÅéÂ§ß");
                            const reader = new FileReader();
                            reader.onload = (evt) => submitPost(e.latlng, text, evt.target.result);
                            reader.readAsDataURL(file);
                        } else {
                            submitPost(e.latlng, text, null);
                        }
                    };
                }, 100);
            });

            function submitPost(latlng, text, imageData) {
                db.collection("posts").add({
                    lat: latlng.lat, lng: latlng.lng, text: text, image: imageData,
                    date: new Date().toISOString(), uid: currentUser.uid,
                    authorName: userProfile.name, authorPhoto: userProfile.photo, likedBy: []
                }).then(() => map.closePopup()).catch(e => alert(e.message));
            }

            function addSidebarItem(docId, data, marker) {
                const list = document.getElementById('comment-list');
                const li = document.createElement('li');
                li.className = 'comment-item';
                if (docId === selectedDocId) li.classList.add('active'); // ÈÅ∏ÊäûÁä∂ÊÖã„ÅÆÁ∂≠ÊåÅ
                if (currentUser && data.uid === currentUser.uid) li.classList.add('my-post');

                const avatar = document.createElement('img');
                avatar.className = 'item-avatar';
                avatar.src = data.authorPhoto || 'https://placehold.co/40';
                li.appendChild(avatar);

                const body = document.createElement('div');
                body.className = 'item-body';
                
                const header = document.createElement('div');
                header.className = 'item-header';
                const timeStr = new Date(data.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                header.innerHTML = `<span class="item-author">${data.authorName}</span> <span class="item-time">${timeStr}</span>`;
                body.appendChild(header);

                const textDiv = document.createElement('div');
                textDiv.className = 'item-text';
                textDiv.innerHTML = formatTextWithHashtags(data.text);
                body.appendChild(textDiv);

                const footer = document.createElement('div');
                footer.className = 'item-footer';
                
                const likeBtn = document.createElement('button');
                likeBtn.className = 'item-like-btn';
                const likeCount = data.likedBy ? data.likedBy.length : 0;
                const isLiked = currentUser && data.likedBy && data.likedBy.includes(currentUser.uid);
                
                likeBtn.innerHTML = `<i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${likeCount || ''}`;
                if(isLiked) likeBtn.classList.add('liked');

                likeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(!currentUser) return alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                    const postRef = db.collection("posts").doc(docId);
                    if (isLiked) {
                        postRef.update({ likedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                    } else {
                        postRef.update({ likedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                    }
                };
                footer.appendChild(likeBtn);

                const delBtn = document.createElement('i');
                delBtn.className = 'fas fa-trash item-delete-btn';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                        // Ê•ΩË¶≥ÁöÑÂâäÈô§„ÅØ„Åõ„ÅöDBÊõ¥Êñ∞„ÇíÂæÖ„Å§
                        db.collection("posts").doc(docId).delete();
                    }
                };
                footer.appendChild(delBtn);
                body.appendChild(footer);
                li.appendChild(body);

                if (data.image) {
                    const thumb = document.createElement('img');
                    thumb.className = 'item-right-img';
                    thumb.src = data.image;
                    li.appendChild(thumb);
                }

                // ‚òÖ „É™„Çπ„Éà„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜÔºàÊúÄÂâçÈù¢ÂåñÔºâ
                li.onclick = (e) => {
                    if(e.target.closest('button') || e.target.closest('i')) return;
                    
                    // ÈÅ∏ÊäûID„ÇíÊõ¥Êñ∞
                    selectedDocId = docId;
                    
                    // Âú∞Âõ≥ÁßªÂãï
                    map.panTo(marker.getLatLng());
                    
                    // Ë¶ã„ÅüÁõÆ„ÅÆÊõ¥Êñ∞ÔºàrefreshUI„ÇíÂëº„Å∂„Åì„Å®„ÅßZ-index„ÇÇÂÜçË®àÁÆó„Åï„Çå„ÇãÔºâ
                    refreshUI(); 
                    
                    // „É™„Çπ„Éà„ÅÆ„Çπ„ÇØ„É≠„Éº„É´
                    li.scrollIntoView({ behavior: 'smooth', block: 'center' });
                };
                list.appendChild(li);
            }

            function createCustomIcon(text, image) {
                if(text.length > 10) text = text.substring(0, 10) + "...";
                
                let circleClass = 'marker-circle';
                let circleStyle = '';

                if (image) {
                    circleClass += ' has-image';
                    circleStyle = `background-image: url('${image}');`;
                } else {
                    circleClass += ' no-image';
                }

                const html = `
                    <div class="marker-container">
                        <div class="marker-bubble">
                            <span class="marker-content">${text}</span>
                        </div>
                        <div class="${circleClass}" style="${circleStyle}"></div>
                    </div>`;
                
                return L.divIcon({
                    html: html,
                    className: '', 
                    iconSize: [120, 70], 
                    iconAnchor: [60, 65]
                });
            }

            function formatTextWithHashtags(text) { 
                return text ? text.replace(/(#\S+)/g, '<span class="hashtag">$1</span>') : ""; 
            }

            document.getElementById('gps-btn').onclick = function() {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(pos => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(latlng, 16);
                    if (currentLocationMarker) currentLocationMarker.setLatLng(latlng);
                    else {
                        currentLocationMarker = L.circleMarker(latlng, { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                    }
                    currentLocationMarker.bindPopup("ÁèæÂú®Âú∞").openPopup();
                });
            };
        };
    </script>
</body>
</html>