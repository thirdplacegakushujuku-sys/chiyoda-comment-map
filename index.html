<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åƒä»£ç”°åŒºã‚³ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒ—</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body { margin: 0; padding: 0; overflow: hidden; font-family: "Helvetica Neue", Arial, sans-serif; color: #333; background: #fff; }
        
        #container { display: flex; height: 100vh; width: 100vw; flex-direction: row; }

        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ --- */
        #sidebar {
            width: 340px; background-color: #fff; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; z-index: 2000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05); position: relative;
        }

        /* --- åœ°å›³ã‚¨ãƒªã‚¢ --- */
        #mapid { flex: 1; height: 100%; background-color: #fff; position: relative; }

        /* ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 600px) {
            #container { flex-direction: column; }
            #mapid { height: 50%; width: 100%; order: 1; }
            #sidebar { width: 100%; height: 50%; border-right: none; border-top: 1px solid #ddd; order: 2; }
            #sidebar-toggle { display: none; }
        }

        /* PCç”¨é–‹é–‰ãƒœã‚¿ãƒ³ */
        #sidebar-toggle {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background-color: white; border: 1px solid #ddd; color: #555;
            border-radius: 4px; padding: 5px 10px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒªã‚¢ --- */
        #login-section {
            padding: 15px; background-color: #fff; border-bottom: 1px solid #eee;
        }
        #user-info { display: none; align-items: center; gap: 10px; }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³ç·¨é›†ç”¨ */
        .user-icon-wrapper { position: relative; cursor: pointer; }
        #user-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .icon-edit-overlay {
            position: absolute; bottom: 0; right: -5px; background: #007bff; color: white;
            border-radius: 50%; width: 16px; height: 16px; font-size: 10px;
            display: flex; align-items: center; justify-content: center; border: 1px solid white;
        }
        
        #user-details { flex: 1; overflow: hidden; }
        #user-name { font-weight: bold; font-size: 14px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .edit-btn { background: none; border: none; color: #007bff; font-size: 11px; cursor: pointer; padding: 0; }
        
        .auth-btn { width: 100%; padding: 8px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-login { background-color: #4285f4; color: white; }
        .btn-logout { background-color: #f0f0f0; color: #555; width: auto; font-size: 11px; padding: 4px 8px; }

        /* --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆã‚¨ãƒªã‚¢ --- */
        #filter-section {
            padding: 10px 15px; border-bottom: 1px solid #eee; background: #fcfcfc;
            display: flex; gap: 10px; align-items: center;
        }
        .sort-select, .filter-select {
            padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: #fff;
        }

        #sidebar-content { flex: 1; overflow-y: auto; padding: 0; }

        /* --- ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ --- */
        #comment-list { list-style: none; padding: 0; margin: 0; }
        .comment-item {
            display: flex; align-items: flex-start; padding: 12px 15px; border-bottom: 1px solid #f5f5f5;
            cursor: pointer; transition: all 0.2s;
        }
        .comment-item:hover { background-color: #fafafa; }
        
        /* ä¸Šå“ãªå¼·èª¿è¡¨ç¤º */
        .comment-item.active {
            background-color: #fdfdfd;
            box-shadow: inset 4px 0 0 #007bff; /* å·¦ç«¯ã«é’ã„ãƒ©ã‚¤ãƒ³ */
        }

        .item-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; object-fit: cover; background: #eee; flex-shrink: 0; }
        
        .item-body { flex: 1; min-width: 0; margin-right: 10px; }
        .item-header { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .item-author { font-weight: bold; font-size: 13px; color: #333; }
        .item-time { font-size: 11px; color: #999; }
        .item-text { font-size: 13px; color: #444; line-height: 1.4; word-wrap: break-word; }
        
        .item-footer { display: flex; align-items: center; gap: 10px; margin-top: 6px; }
        .item-like-btn {
            background: none; border: none; cursor: pointer; color: #ccc; font-size: 13px;
            padding: 2px 5px; display: flex; align-items: center; gap: 4px; transition: color 0.2s;
        }
        .item-like-btn:hover { color: #ff4081; }
        .item-like-btn.liked { color: #ff4081; }
        
        .item-delete-btn { color: #ccc; cursor: pointer; font-size: 12px; display: none; }
        .item-delete-btn:hover { color: #ff4444; }
        .my-post .item-delete-btn { display: inline-block; }

        /* å³å´ã®ç”»åƒã‚µãƒ ãƒã‚¤ãƒ« */
        .item-right-img {
            width: 60px; height: 60px; border-radius: 6px; object-fit: cover;
            border: 1px solid #eee; background: #f9f9f9; flex-shrink: 0;
        }

        /* --- ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´ --- */
        .custom-pin-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        /* å¹ãå‡ºã—ï¼ˆãƒ”ãƒ«å‹ï¼‰ */
        .custom-pin-bubble {
            background-color: #fff; color: #333; 
            border: 1px solid #ccc; 
            border-radius: 20px; /* ä¸¸ãã™ã‚‹ */
            padding: 4px 10px; font-size: 11px; font-weight: bold; white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            max-width: 150px; overflow: hidden; text-overflow: ellipsis;
        }
        
        /* ä¸‰è§’å½¢ï¼ˆâ–¼ï¼‰ã¯éè¡¨ç¤ºã«ã™ã‚‹ */
        .custom-pin-bubble::after { display: none; }

        /* ä¸Šå“ãªå¼·èª¿ï¼ˆåœ°å›³ä¸Šã®ãƒ”ãƒ³ï¼‰ */
        .highlight-pin .custom-pin-bubble {
            border-color: #007bff;
            background-color: #fff;
            color: #007bff;
            transform: scale(1.1);
            /* é’ã„å…‰å½© */
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            z-index: 10000 !important;
        }

        /* ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚° */
        .hashtag { color: #007bff; margin-right: 2px; }

        /* --- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®æ”¹å–„ --- */
        .comment-form { text-align: center; width: 240px; padding: 5px; }
        .form-header { font-size: 12px; color: #666; margin-bottom: 8px; text-align: left; }
        .comment-input {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd;
            border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        
        .form-actions { display: flex; justify-content: space-between; align-items: center; }
        
        /* ã‚«ãƒ¡ãƒ©/ç”»åƒé¸æŠã‚¢ã‚¤ã‚³ãƒ³ */
        .image-upload-label {
            cursor: pointer; color: #007bff; font-size: 20px; padding: 5px;
            transition: color 0.2s;
        }
        .image-upload-label:hover { color: #0056b3; }
        .image-upload-label.has-file { color: #28a745; } /* é¸æŠæ¸ˆã¿ãªã‚‰ç·‘ */
        
        /* éš ã—input */
        #post-file-input, #avatar-upload-input { display: none; }

        .comment-btn {
            padding: 8px 20px; background: #007bff; color: white; border: none;
            border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px;
        }
        .comment-btn:disabled { background: #ccc; }

        /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ */
        #gps-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            background-color: white; border: none; border-radius: 50%;
            width: 44px; height: 44px; cursor: pointer; color: #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: background 0.2s;
        }
        #gps-btn:active { background: #f0f0f0; }

        /* èª­ã¿è¾¼ã¿ä¸­ */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="container">
        <div id="sidebar">
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
            <div id="login-section">
                <button id="login-btn" class="auth-btn btn-login">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                
                <div id="user-info">
                    <!-- ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ -->
                    <label for="avatar-upload-input" class="user-icon-wrapper" title="ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´">
                        <img id="user-icon" src="" alt="icon">
                        <div class="icon-edit-overlay"><i class="fas fa-camera"></i></div>
                    </label>
                    <input type="file" id="avatar-upload-input" accept="image/*">

                    <div id="user-details">
                        <span id="user-name"></span>
                        <button id="edit-name-btn" class="edit-btn">åå‰ã‚’å¤‰æ›´</button>
                    </div>
                    <button id="logout-btn" class="auth-btn btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆ -->
            <div id="filter-section">
                <select id="sort-select" class="sort-select">
                    <option value="newest">ğŸ•’ æ–°ç€é †</option>
                    <option value="likes">â¤ï¸ ã„ã„ã­é †</option>
                </select>
                <select id="filter-select" class="filter-select">
                    <option value="all">å…¨æœŸé–“</option>
                    <option value="24h">24æ™‚é–“ä»¥å†…</option>
                    <option value="7d">1é€±é–“ä»¥å†…</option>
                </select>
            </div>

            <div id="sidebar-content">
                <ul id="comment-list">
                    <div id="loading-spinner" class="loader"></div>
                </ul>
            </div>
        </div>

        <div id="mapid">
            <button id="sidebar-toggle" onclick="toggleSidebar()">â—€</button>
            <button id="gps-btn" title="ç¾åœ¨åœ°ã¸"><i class="fas fa-location-arrow"></i></button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        // =========================================================
        // ğŸ”¥ é‡è¦: è‡ªåˆ†ã® firebaseConfig ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
        // =========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyCZxC2imSus21qmrN4OelItvq9pyGJm0sE",
          authDomain: "chiyoda-map-sns.firebaseapp.com",
          projectId: "chiyoda-map-sns",
          storageBucket: "chiyoda-map-sns.firebasestorage.app",
          messagingSenderId: "140311034396",
          appId: "1:140311034396:web:eff090822e46f6d5787dd9"
        };
        // =========================================================

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            var btn = document.getElementById('sidebar-toggle');
            if(sb.style.display === 'none') { sb.style.display = 'flex'; btn.innerText = 'â—€'; }
            else { sb.style.display = 'none'; btn.innerText = 'â–¶'; }
        }

        window.onload = function() {
            if (typeof L === 'undefined') { alert('åœ°å›³ã‚¨ãƒ©ãƒ¼'); return; }
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(e=>{});

            // åœ°å›³åˆæœŸåŒ–
            var center = [35.685175, 139.752762];
            var map = L.map('mapid', { zoomControl: false }).setView(center, 14);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap', className: '' }).addTo(map);

            // å¤‰æ•°
            var markersMap = {};
            var currentPostsData = []; // ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            var topZIndex = 1000;
            var currentLocationMarker = null;
            var currentUser = null;
            var userProfile = { name: "", photo: "" };
            var unsubscribe = null;

            // èªè¨¼ç›£è¦–
            document.getElementById('login-btn').onclick = () => auth.signInWithPopup(provider).catch(e => alert(e.message));
            document.getElementById('logout-btn').onclick = () => auth.signOut();
            
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    await loadUserProfile(user);
                    document.getElementById('login-btn').style.display='none';
                    document.getElementById('user-info').style.display='flex';
                    updateProfileUI();
                } else {
                    document.getElementById('login-btn').style.display='block';
                    document.getElementById('user-info').style.display='none';
                    userProfile = { name: "", photo: "" };
                }
                setupDataListener();
            });

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
            async function loadUserProfile(user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    userProfile.name = data.handleName || user.displayName;
                    userProfile.photo = data.photoURL || user.photoURL;
                } else {
                    userProfile.name = user.displayName;
                    userProfile.photo = user.photoURL;
                    await db.collection('users').doc(user.uid).set({
                        handleName: userProfile.name,
                        photoURL: userProfile.photo,
                        updatedAt: new Date().toISOString()
                    });
                }
            }

            function updateProfileUI() {
                document.getElementById('user-name').textContent = userProfile.name;
                document.getElementById('user-icon').src = userProfile.photo;
            }

            // åå‰å¤‰æ›´
            document.getElementById('edit-name-btn').onclick = async function() {
                const newName = prompt("æ–°ã—ã„åå‰:", userProfile.name);
                if(newName && newName.trim()) {
                    await db.collection('users').doc(currentUser.uid).update({ handleName: newName });
                    userProfile.name = newName;
                    updateProfileUI();
                }
            };

            // ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´ (ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
            document.getElementById('avatar-upload-input').onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 500 * 1024) { alert("ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™(500KBä»¥ä¸‹æ¨å¥¨)"); return; }
                
                const reader = new FileReader();
                reader.onload = async function(evt) {
                    const base64 = evt.target.result;
                    try {
                        await db.collection('users').doc(currentUser.uid).update({ photoURL: base64 });
                        userProfile.photo = base64;
                        updateProfileUI();
                    } catch(err) { alert("ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°å¤±æ•—: " + err.message); }
                };
                reader.readAsDataURL(file);
            };

            // ãƒ‡ãƒ¼ã‚¿ç›£è¦–ã¨å–å¾—
            function setupDataListener() {
                if(unsubscribe) unsubscribe();
                // â€»ä¸¦ã³æ›¿ãˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§è¡Œã†ãŸã‚ã€Firestoreå´ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸¦ã³ã ã‘ã§å–å¾—
                unsubscribe = db.collection("posts").onSnapshot((snapshot) => {
                    document.getElementById('loading-spinner').style.display = 'none';
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ä¿æŒ
                    currentPostsData = [];
                    snapshot.forEach(doc => {
                        currentPostsData.push({ id: doc.id, ...doc.data() });
                    });

                    refreshUI(); // ç”»é¢æ›´æ–°
                });
            }

            // UIæ›´æ–° (ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ»æç”»)
            function refreshUI() {
                const sortMode = document.getElementById('sort-select').value;
                const filterMode = document.getElementById('filter-select').value;
                const list = document.getElementById('comment-list');
                list.innerHTML = ""; // ã‚¯ãƒªã‚¢

                // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                let filteredData = currentPostsData.filter(item => {
                    if (filterMode === 'all') return true;
                    const date = new Date(item.date);
                    const now = new Date();
                    const diffMs = now - date;
                    if (filterMode === '24h') return diffMs < 24 * 60 * 60 * 1000;
                    if (filterMode === '7d') return diffMs < 7 * 24 * 60 * 60 * 1000;
                    return true;
                });

                // 2. ã‚½ãƒ¼ãƒˆ
                filteredData.sort((a, b) => {
                    if (sortMode === 'newest') {
                        return new Date(b.date) - new Date(a.date);
                    } else if (sortMode === 'likes') {
                        // ã„ã„ã­æ•°ãŒå¤šã„é †ã€‚åŒã˜ãªã‚‰æ–°ã—ã„é †
                        const likeA = a.likedBy ? a.likedBy.length : 0;
                        const likeB = b.likedBy ? b.likedBy.length : 0;
                        if (likeB !== likeA) return likeB - likeA;
                        return new Date(b.date) - new Date(a.date);
                    }
                });

                // 3. æç”» (åœ°å›³ãƒ”ãƒ³ã¨ãƒªã‚¹ãƒˆ)
                // ã¾ãšåœ°å›³ãƒ”ãƒ³ã®ä¸è¦ãªã‚‚ã®ã‚’å‰Šé™¤ã™ã‚‹å‡¦ç†ãŒå¿…è¦ã ãŒã€
                // ç°¡æ˜“çš„ã«ã€æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚’ç¶­æŒã—ã¤ã¤ä½ç½®ã‚„å†…å®¹ã‚’æ›´æ–°ã™ã‚‹æ–¹é‡ã§è¡Œã
                
                filteredData.forEach(data => {
                    const docId = data.id;
                    const likeCount = data.likedBy ? data.likedBy.length : 0;

                    // ãƒ”ãƒ³ä½œæˆãƒ»æ›´æ–°
                    if (!markersMap[docId]) {
                        const icon = createCustomIcon(data.text, likeCount);
                        const marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                        
                        // Z-index: ã„ã„ã­ãŒå¤šã„ã»ã©æ‰‹å‰ã€ã‹ã¤IDé †ã§å¾®èª¿æ•´
                        marker.setZIndexOffset(likeCount * 100); 
                        markersMap[docId] = marker;
                    } else {
                        const marker = markersMap[docId];
                        marker.setIcon(createCustomIcon(data.text, likeCount));
                        marker.setZIndexOffset(likeCount * 100);
                    }

                    // ãƒªã‚¹ãƒˆè¿½åŠ 
                    addSidebarItem(docId, data, markersMap[docId]);
                });
                
                // â€»ãƒ•ã‚£ãƒ«ã‚¿ã§æ¶ˆãˆãŸãƒ”ãƒ³ã‚’å‰Šé™¤ã™ã‚‹å‡¦ç†ã¯çœç•¥ï¼ˆå®Ÿé‹ç”¨ã§ã¯å¿…è¦ï¼‰
            }

            // ã‚½ãƒ¼ãƒˆ/ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('sort-select').onchange = refreshUI;
            document.getElementById('filter-select').onchange = refreshUI;

            // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ -> æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ 
            map.on('click', function(e) {
                if(e.originalEvent.target.closest('button')) return;
                
                const container = document.createElement('div');
                container.className = 'comment-form';
                
                if (!currentUser) {
                    container.innerHTML = `<div style="font-size:12px;color:red;margin-bottom:10px;">æŠ•ç¨¿ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>`;
                } else {
                    container.innerHTML = `
                        <div class="form-header"><b>${userProfile.name}</b> ã¨ã—ã¦æŠ•ç¨¿</div>
                        <input type="text" id="post-text" class="comment-input" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...">
                        <div class="form-actions">
                            <label for="post-file-input" class="image-upload-label" id="file-label">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="post-file-input" accept="image/*" capture="environment">
                            <button id="submit-post" class="comment-btn">æŠ•ç¨¿</button>
                        </div>
                    `;
                }
                
                const popup = L.popup().setLatLng(e.latlng).setContent(container).openOn(map);

                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ãŸå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                setTimeout(() => {
                    if(!currentUser) return;
                    
                    const fileInput = document.getElementById('post-file-input');
                    const label = document.getElementById('file-label');
                    const btn = document.getElementById('submit-post');
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²ã‚’å¤‰ãˆã‚‹
                    fileInput.onchange = () => {
                        if(fileInput.files.length > 0) label.classList.add('has-file');
                        else label.classList.remove('has-file');
                    };

                    btn.onclick = () => {
                        const text = document.getElementById('post-text').value;
                        if(!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                        
                        const file = fileInput.files[0];
                        if (file) {
                            if (file.size > 800 * 1024) return alert("ç”»åƒã‚µã‚¤ã‚ºéå¤§");
                            const reader = new FileReader();
                            reader.onload = (evt) => submitPost(e.latlng, text, evt.target.result);
                            reader.readAsDataURL(file);
                        } else {
                            submitPost(e.latlng, text, null);
                        }
                    };
                }, 100);
            });

            function submitPost(latlng, text, imageData) {
                db.collection("posts").add({
                    lat: latlng.lat, lng: latlng.lng, text: text, image: imageData,
                    date: new Date().toISOString(),
                    uid: currentUser.uid,
                    authorName: userProfile.name,
                    authorPhoto: userProfile.photo,
                    likedBy: [] // ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ãƒªã‚¹ãƒˆ
                }).then(() => map.closePopup()).catch(e => alert(e.message));
            }

            // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
            function addSidebarItem(docId, data, marker) {
                const list = document.getElementById('comment-list');
                const li = document.createElement('li');
                li.className = 'comment-item';
                if (currentUser && data.uid === currentUser.uid) li.classList.add('my-post');

                // å·¦: ã‚¢ã‚¤ã‚³ãƒ³
                const avatar = document.createElement('img');
                avatar.className = 'item-avatar';
                avatar.src = data.authorPhoto || 'https://placehold.co/40';
                li.appendChild(avatar);

                // ä¸­å¤®: å†…å®¹
                const body = document.createElement('div');
                body.className = 'item-body';
                
                const header = document.createElement('div');
                header.className = 'item-header';
                const timeStr = new Date(data.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                header.innerHTML = `<span class="item-author">${data.authorName}</span> <span class="item-time">${timeStr}</span>`;
                body.appendChild(header);

                const textDiv = document.createElement('div');
                textDiv.className = 'item-text';
                textDiv.innerHTML = formatTextWithHashtags(data.text);
                body.appendChild(textDiv);

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (ã„ã„ã­ãƒ»å‰Šé™¤)
                const footer = document.createElement('div');
                footer.className = 'item-footer';
                
                const likeBtn = document.createElement('button');
                likeBtn.className = 'item-like-btn';
                const likeCount = data.likedBy ? data.likedBy.length : 0;
                const isLiked = currentUser && data.likedBy && data.likedBy.includes(currentUser.uid);
                
                likeBtn.innerHTML = `<i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${likeCount || ''}`;
                if(isLiked) likeBtn.classList.add('liked');

                likeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
                    
                    const postRef = db.collection("posts").doc(docId);
                    if (isLiked) {
                        // è§£é™¤
                        postRef.update({ likedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                    } else {
                        // ã„ã„ã­
                        postRef.update({ likedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                    }
                };
                footer.appendChild(likeBtn);

                const delBtn = document.createElement('i');
                delBtn.className = 'fas fa-trash item-delete-btn';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                        li.remove(); map.removeLayer(marker);
                        db.collection("posts").doc(docId).delete();
                    }
                };
                footer.appendChild(delBtn);
                
                body.appendChild(footer);
                li.appendChild(body);

                // å³: ç”»åƒ (ã‚ã‚Œã°)
                if (data.image) {
                    const thumb = document.createElement('img');
                    thumb.className = 'item-right-img';
                    thumb.src = data.image;
                    li.appendChild(thumb);
                }

                // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æŒ™å‹•
                li.onclick = (e) => {
                    if(e.target.closest('button') || e.target.closest('i')) return; // ãƒœã‚¿ãƒ³é¡ã¯ç„¡è¦–
                    
                    // ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç† (ä¸Šå“ãªã‚·ãƒ£ãƒ‰ã‚¦)
                    document.querySelectorAll('.highlight-pin').forEach(el => el.classList.remove('highlight-pin'));
                    if(marker.getElement()) marker.getElement().classList.add('highlight-pin');
                    
                    document.querySelectorAll('.comment-item').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');

                    map.panTo(marker.getLatLng());
                };

                list.appendChild(li);
            }

            function createCustomIcon(text, likeCount) {
                // æ–‡å­—æ•°åˆ¶é™
                if(text.length > 10) text = text.substring(0, 10) + "...";
                
                // ã‚·ãƒ³ãƒ—ãƒ«ãªå¹ãå‡ºã—ã®ã¿
                const html = `
                    <div class="custom-pin-container">
                        <div class="custom-pin-bubble">${text}</div>
                    </div>`;
                return L.divIcon({ html: html, className: '', iconSize: [0, 0], iconAnchor: [0, 0] });
            }

            function formatTextWithHashtags(text) { 
                return text ? text.replace(/(#\S+)/g, '<span class="hashtag">$1</span>') : ""; 
            }

            // ç¾åœ¨åœ°
            document.getElementById('gps-btn').onclick = function() {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(pos => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(latlng, 16);
                    if (currentLocationMarker) currentLocationMarker.setLatLng(latlng);
                    else {
                        currentLocationMarker = L.circleMarker(latlng, { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                    }
                    currentLocationMarker.bindPopup("ç¾åœ¨åœ°").openPopup();
                });
            };
        };
    </script>
</body>
</html>