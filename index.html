<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åƒä»£ç”°åŒºã‚³ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒ—</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body { margin: 0; padding: 0; overflow: hidden; font-family: "Helvetica Neue", Arial, sans-serif; color: #333; }
        
        /* ã‚³ãƒ³ãƒ†ãƒŠè¨­å®šï¼šã‚¹ãƒãƒ›ã¯ç¸¦ä¸¦ã³ã€PCã¯æ¨ªä¸¦ã³ */
        #container { 
            display: flex; 
            height: 100vh; 
            width: 100vw; 
            flex-direction: row; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆPCï¼‰ã¯æ¨ªä¸¦ã³ */
        }

        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼‰ --- */
        #sidebar {
            width: 320px; 
            background-color: #fff; 
            border-right: 1px solid #ddd;
            display: flex; 
            flex-direction: column; 
            z-index: 2000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: relative; /* PCã§ã¯ç›¸å¯¾é…ç½® */
        }

        /* --- åœ°å›³ã‚¨ãƒªã‚¢ --- */
        #mapid { 
            flex: 1; 
            height: 100%; 
            background-color: #eee; 
            position: relative; 
        }

        /* --- ğŸ“± ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š (å¹…600pxä»¥ä¸‹) --- */
        @media (max-width: 600px) {
            #container {
                flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
            }
            #mapid {
                height: 55%; /* åœ°å›³ã‚’å°‘ã—åºƒã‚ã« */
                width: 100%;
                order: 1; /* åœ°å›³ã‚’ä¸Šã« */
            }
            #sidebar {
                width: 100%;
                height: 45%; /* ãƒªã‚¹ãƒˆã‚’ä¸‹éƒ¨ã« */
                border-right: none;
                border-top: 1px solid #ddd;
                order: 2; /* ãƒªã‚¹ãƒˆã‚’ä¸‹ã« */
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }
            /* ã‚¹ãƒãƒ›ã§ã¯é–‹é–‰ãƒœã‚¿ãƒ³ã‚’éš ã™ï¼ˆå¸¸ã«ä¸Šä¸‹åˆ†å‰²ã§è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰ */
            #sidebar-toggle {
                display: none;
            }
        }

        /* é–‹é–‰ãƒœã‚¿ãƒ³ï¼ˆPCç”¨ï¼‰ */
        #sidebar-toggle {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background-color: white; border: 2px solid #007bff; color: #007bff;
            border-radius: 4px; padding: 5px 10px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #login-section {
            padding: 10px; background-color: #f8f9fa; border-bottom: 1px solid #ddd;
            display: flex; align-items: center; justify-content: space-between;
        }
        #user-info { display: none; align-items: center; gap: 8px; width: 100%; }
        #user-icon { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid #ccc;}
        #user-name { font-weight: bold; font-size: 12px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .auth-btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-login { background-color: #4285f4; color: white; width: 100%; }
        .btn-logout { background-color: #eee; color: #333; }

        #sidebar-content { flex: 1; overflow-y: auto; padding: 0; } /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãªãã—ã¦ã‚¹ãƒƒã‚­ãƒª */
        #hashtag-section {
            padding: 10px; background-color: #f8f9fa; border-top: 1px solid #ddd;
            font-size: 11px; white-space: nowrap; overflow-x: auto;
        }

        /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ */
        #gps-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            background-color: white; border: 2px solid #ccc; border-radius: 50%;
            width: 40px; height: 40px; cursor: pointer; font-weight: bold; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        /* --- âœ¨ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ --- */
        #comment-list { list-style: none; padding: 0; margin: 0; }
        
        .comment-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            height: 50px; /* é«˜ã•ã‚’å›ºå®šã—ã¦æ•´åˆ— */
        }
        .comment-item:hover { background-color: #f5f5f5; }
        .comment-item.active { background-color: #eef6ff; border-left: 4px solid #007bff; padding-left: 8px; }
        .comment-item.my-post { background-color: #fff; } /* è‡ªåˆ†ã®æŠ•ç¨¿ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã« */

        /* ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒï¼ˆå·¦ç«¯ï¼‰ */
        .item-thumb {
            width: 36px; height: 36px; border-radius: 4px; object-fit: cover;
            margin-right: 10px; background-color: #eee; border: 1px solid #ddd;
            flex-shrink: 0;
        }
        /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆä¸­å¤®ï¼‰ */
        .item-content {
            flex: 1;
            min-width: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ã§ã®çœç•¥è¡¨ç¤ºã«å¿…é ˆ */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .item-text {
            font-size: 13px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* ...ã§çœç•¥ */
        }
        .item-meta {
            font-size: 10px;
            color: #999;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ï¼ˆå³ç«¯ï¼‰ */
        .item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }
        
        /* ã„ã„ã­ãƒœã‚¿ãƒ³ï¼ˆãƒãƒ¼ãƒˆã®ã¿ï¼‰ */
        .item-like-btn {
            background: none; border: none; cursor: pointer; color: #ccc;
            font-size: 14px; padding: 0; display: flex; align-items: center; gap: 2px;
        }
        .item-like-btn.liked { color: #ff4081; }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆÃ—ã®ã¿ï¼‰ */
        .item-delete-btn {
            background: none; border: none; cursor: pointer; color: #999;
            font-size: 18px; padding: 0 5px; display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
        }
        .item-delete-btn:hover { color: #ff4444; }
        .my-post .item-delete-btn { display: block; } /* è‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿è¡¨ç¤º */

        .hashtag { color: #007bff; margin-right: 3px; }

        /* äººæ°—ã‚¿ã‚° */
        .popular-tag { display: inline-block; background-color: #fff; color: #007bff; border-radius: 12px; padding: 2px 8px; margin-right: 5px; border: 1px solid #b3d7ff; }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ */
        .custom-pin-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        .custom-pin-bubble {
            background-color: #fff; color: #333; border: 2px solid #333; border-radius: 8px;
            padding: 4px 8px; font-size: 11px; font-weight: bold; white-space: nowrap;
            box-shadow: 2px 4px 6px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 4px;
            transition: transform 0.2s; margin-bottom: 4px;
        }
        .highlight-pin .custom-pin-bubble { background-color: #ff4081; color: white; border-color: #c51162; transform: scale(1.2); z-index: 9999; }
        .highlight-pin .custom-pin-bubble::after { border-top-color: #333; }
        .custom-pin-bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
            border-width: 6px 6px 0; border-style: solid; border-color: #333 transparent transparent transparent;
        }
        .custom-pin-dot { width: 10px; height: 10px; background-color: #007bff; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5); }
        .pin-thumbnail { width: 30px; height: 30px; object-fit: cover; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: block; margin: 0 auto 4px auto; background-color: #ddd; }

        /* æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  */
        .comment-form { text-align: center; width: 220px; }
        .comment-input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .file-input { width: 100%; margin-bottom: 10px; font-size: 12px; }
        .comment-btn { width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="container">
        <!-- ğŸ“± ã‚¹ãƒãƒ›: ä¸‹ / PC: å·¦ -->
        <div id="sidebar">
            <div id="login-section">
                <button id="login-btn" class="auth-btn btn-login">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="user-info">
                    <img id="user-icon" src="" alt="icon">
                    <span id="user-name"></span>
                    <button id="logout-btn" class="auth-btn btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>

            <div id="sidebar-content">
                <ul id="comment-list">
                    <li id="loading-msg" style="text-align:center; color:#999; padding:20px; font-size:12px;">
                        èª­ã¿è¾¼ã¿ä¸­...
                    </li>
                </ul>
            </div>
            
            <div id="hashtag-section">
                <!-- äººæ°—ã‚¿ã‚° -->
            </div>
        </div>

        <!-- ğŸ“± ã‚¹ãƒãƒ›: ä¸Š / PC: å³ -->
        <div id="mapid">
            <!-- PCç”¨ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ãƒœã‚¿ãƒ³ -->
            <button id="sidebar-toggle" onclick="toggleSidebar()">â—€</button>
            <button id="gps-btn" title="ç¾åœ¨åœ°ã¸">ğŸ“</button>
        </div>
    </div>

    <!-- Firebaseãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        // =========================================================
        // ğŸ”¥ è¨­å®šå€¤ (APIã‚­ãƒ¼é©ç”¨æ¸ˆã¿)
        // =========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyCZxC2imSus21qmrN4OelItvq9pyGJm0sE",
          authDomain: "chiyoda-map-sns.firebaseapp.com",
          projectId: "chiyoda-map-sns",
          storageBucket: "chiyoda-map-sns.firebasestorage.app",
          messagingSenderId: "140311034396",
          appId: "1:140311034396:web:eff090822e46f6d5787dd9"
        };
        // =========================================================

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ï¼ˆPCç”¨ï¼‰
        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            var btn = document.getElementById('sidebar-toggle');
            if(sb.style.display === 'none') {
                sb.style.display = 'flex'; btn.innerText = 'â—€';
            } else {
                sb.style.display = 'none'; btn.innerText = 'â–¶';
            }
        }

        window.onload = function() {
            if (typeof L === 'undefined') { alert('åœ°å›³ã‚¨ãƒ©ãƒ¼'); return; }
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(e=>{});

            var center = [35.685175, 139.752762];
            var map = L.map('mapid', { zoomControl: false }).setView(center, 14);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap', className: 'grayscale-tile' }).addTo(map);

            var worldLatLngs = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
            var chiyodaHole = [[35.706, 139.728], [35.706, 139.784], [35.668, 139.784], [35.668, 139.728]];
            L.polygon([worldLatLngs, chiyodaHole], { color: 'transparent', fillColor: '#000', fillOpacity: 0.6, interactive: false }).addTo(map);

            var markersMap = {};
            var hashtagStats = {};
            var topZIndex = 1000;
            var currentLocationMarker = null;
            var currentUser = null;
            var unsubscribe = null;

            // èªè¨¼
            document.getElementById('login-btn').onclick = () => auth.signInWithPopup(provider).catch(e => alert(e.message));
            document.getElementById('logout-btn').onclick = () => auth.signOut();
            auth.onAuthStateChanged(user => { currentUser = user; updateLoginUI(user); setupDataListener(); });

            function updateLoginUI(user) {
                if(user){
                    document.getElementById('login-btn').style.display='none';
                    document.getElementById('user-info').style.display='flex';
                    document.getElementById('user-icon').src = user.photoURL;
                    document.getElementById('user-name').textContent = user.displayName;
                } else {
                    document.getElementById('login-btn').style.display='block';
                    document.getElementById('user-info').style.display='none';
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ç›£è¦–
            function setupDataListener() {
                if(unsubscribe) unsubscribe();
                unsubscribe = db.collection("posts").orderBy("date", "desc").onSnapshot((snapshot) => {
                    document.getElementById('loading-msg').style.display = 'none';
                    var list = document.getElementById('comment-list');
                    list.innerHTML = "";
                    hashtagStats = {};

                    snapshot.forEach((doc) => {
                        var data = doc.data();
                        var docId = doc.id;
                        var tags = data.text.match(/(#\S+)/g);
                        if(tags) tags.forEach(t => { hashtagStats[t] = (hashtagStats[t] || 0) + 1; });

                        if (!markersMap[docId]) {
                            var styledText = formatTextWithHashtags(data.text);
                            var customIcon = createCustomIcon(docId, styledText, data.likeCount, data.image);
                            var marker = L.marker([data.lat, data.lng], { icon: customIcon }).addTo(map);
                            markersMap[docId] = marker;
                        } else {
                            var marker = markersMap[docId];
                            var styledText = formatTextWithHashtags(data.text);
                            var newIcon = createCustomIcon(docId, styledText, data.likeCount, data.image);
                            marker.setIcon(newIcon);
                        }
                        addSidebarItem(docId, data, markersMap[docId]);
                    });
                    renderPopularHashtags();
                });
            }

            // æŠ•ç¨¿
            map.on('click', function(e) {
                if(e.originalEvent.target.id === 'gps-btn' || e.originalEvent.target.id === 'sidebar-toggle') return;
                var container = document.createElement('div');
                container.className = 'comment-form';
                if (!currentUser) {
                    container.innerHTML = `<div style="margin-bottom:10px; font-size:12px; color:red;">æŠ•ç¨¿ã™ã‚‹ã«ã¯<br>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>`;
                } else {
                    container.innerHTML = `<div style="margin-bottom:5px;"><b>æ–°ã—ã„æŠ•ç¨¿</b></div>`;
                    var input = document.createElement('input'); input.type = "text"; input.placeholder = "ã‚³ãƒ¡ãƒ³ãƒˆ..."; input.className = 'comment-input'; container.appendChild(input);
                    var fileInput = document.createElement('input'); fileInput.type = "file"; fileInput.accept = "image/*"; fileInput.className = "file-input"; container.appendChild(fileInput);
                    var btn = document.createElement('button'); btn.innerText = "æŠ•ç¨¿"; btn.className = 'comment-btn';
                    btn.onclick = function() {
                        var text = input.value;
                        if(!text) { alert("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
                        var file = fileInput.files[0];
                        if (file) {
                            if(file.size > 800 * 1024) { alert("ç”»åƒãŒå¤§ãã™ãã¾ã™"); return; }
                            var reader = new FileReader();
                            reader.onload = function(evt) { submitToFirebase(e.latlng, text, evt.target.result); };
                            reader.readAsDataURL(file);
                        } else { submitToFirebase(e.latlng, text, null); }
                    };
                    container.appendChild(btn);
                }
                L.popup().setLatLng(e.latlng).setContent(container).openOn(map);
            });

            function submitToFirebase(latlng, text, imageData) {
                db.collection("posts").add({
                    lat: latlng.lat, lng: latlng.lng, text: text, image: imageData, likeCount: 0,
                    date: new Date().toISOString(), uid: currentUser.uid, authorName: currentUser.displayName, authorPhoto: currentUser.photoURL
                }).then(() => map.closePopup()).catch(e => alert(e.message));
            }

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³åˆ·æ–°ï¼‰
            function addSidebarItem(docId, data, marker) {
                var list = document.getElementById('comment-list');
                var li = document.createElement('li');
                li.className = 'comment-item';
                if (currentUser && data.uid === currentUser.uid) li.classList.add('my-post');

                // å·¦: ç”»åƒï¼ˆã‚ã‚Œã°ï¼‰
                var thumbSrc = data.image ? data.image : (data.authorPhoto || 'https://placehold.co/40');
                var thumbDiv = document.createElement('img');
                thumbDiv.className = 'item-thumb';
                thumbDiv.src = thumbSrc;
                li.appendChild(thumbDiv);

                // ä¸­å¤®: ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿æƒ…å ±
                var contentDiv = document.createElement('div');
                contentDiv.className = 'item-content';
                
                var textSpan = document.createElement('span');
                textSpan.className = 'item-text';
                textSpan.innerHTML = formatTextWithHashtags(data.text);
                contentDiv.appendChild(textSpan);

                var metaDiv = document.createElement('div');
                metaDiv.className = 'item-meta';
                var timeStr = new Date(data.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                metaDiv.innerHTML = `<span>${data.authorName}</span> â€¢ <span>${timeStr}</span>`;
                contentDiv.appendChild(metaDiv);
                
                li.appendChild(contentDiv);

                // å³: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                var actionsDiv = document.createElement('div');
                actionsDiv.className = 'item-actions';

                // ã„ã„ã­
                var likeBtn = document.createElement('button');
                likeBtn.className = 'item-like-btn';
                if(data.likeCount > 0) {
                    likeBtn.innerHTML = `â¤ï¸ ${data.likeCount}`;
                    likeBtn.classList.add('liked');
                } else {
                    likeBtn.innerHTML = `ğŸ¤`;
                }
                likeBtn.onclick = function(e) {
                    e.stopPropagation();
                    db.collection("posts").doc(docId).update({ likeCount: (data.likeCount || 0) + 1 });
                };
                actionsDiv.appendChild(likeBtn);

                // å‰Šé™¤ï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰
                var delBtn = document.createElement('button');
                delBtn.className = 'item-delete-btn';
                delBtn.innerHTML = '&times;';
                delBtn.onclick = function(e) {
                    e.stopPropagation();
                    if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                        // ğŸš€ å³æ™‚åæ˜ : DOMã‚’å…ˆã«æ¶ˆã™ï¼ˆæ¥½è¦³çš„UIæ›´æ–°ï¼‰
                        li.remove();
                        map.removeLayer(marker);
                        
                        db.collection("posts").doc(docId).delete().catch(e => {
                            alert("å‰Šé™¤å¤±æ•—: " + e);
                            // å¤±æ•—ã—ãŸã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ãªã©ã‚’ä¿ƒã™ã®ãŒæ­£å¼ã ãŒä»Šå›ã¯ç°¡æ˜“ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿
                        });
                    }
                };
                actionsDiv.appendChild(delBtn);

                li.appendChild(actionsDiv);

                // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ”ãƒ³ã¸ç§»å‹•
                li.onclick = function(e) {
                    if (e.target.closest('button')) return;
                    topZIndex++; marker.setZIndexOffset(topZIndex); map.panTo(marker.getLatLng());
                    var el = marker.getElement();
                    if(el) {
                        document.querySelectorAll('.highlight-pin').forEach(e=>e.classList.remove('highlight-pin'));
                        el.classList.add('highlight-pin');
                        document.querySelectorAll('.comment-item').forEach(e=>e.classList.remove('active'));
                        li.classList.add('active');
                    }
                };

                list.appendChild(li);
            }

            function createCustomIcon(id, text, likeCount, imageData) {
                var thumbHtml = imageData ? `<img src="${imageData}" class="pin-thumbnail">` : '';
                var likeHtml = likeCount > 0 ? ` <span style="color:#ff4081">â¤ï¸${likeCount}</span>` : '';
                var html = `
                    <div class="custom-pin-container">
                        ${thumbHtml}
                        <div class="custom-pin-bubble">${text}${likeHtml}</div>
                        <div class="custom-pin-dot"></div>
                    </div>`;
                return L.divIcon({ html: html, className: '', iconSize: [0, 0], iconAnchor: [0, 0] });
            }

            function formatTextWithHashtags(text) { return text.replace(/(#\S+)/g, '<span class="hashtag">$1</span>'); }

            function renderPopularHashtags() {
                var container = document.getElementById('hashtag-section');
                var sortedTags = Object.keys(hashtagStats).map(k => ({ tag: k, count: hashtagStats[k] })).sort((a,b) => b.count - a.count);
                if (sortedTags.length === 0) { container.innerHTML = "ã‚¿ã‚°ãªã—"; return; }
                container.innerHTML = "";
                sortedTags.slice(0, 10).forEach(i => {
                    var span = document.createElement('span');
                    span.className = 'popular-tag';
                    span.innerHTML = `${i.tag} ${i.count}`;
                    container.appendChild(span);
                });
            }

            document.getElementById('gps-btn').onclick = function() {
                if (!navigator.geolocation) return;
                this.innerText = "âŒ›";
                navigator.geolocation.getCurrentPosition(pos => {
                    var latlng = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(latlng, 16);
                    if (currentLocationMarker) currentLocationMarker.setLatLng(latlng);
                    else {
                        currentLocationMarker = L.circleMarker(latlng, { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                        L.circle(latlng, { radius: pos.coords.accuracy/2, color: 'transparent', fillColor: '#3388ff', fillOpacity: 0.2 }).addTo(map);
                    }
                    currentLocationMarker.bindPopup("ç¾åœ¨åœ°").openPopup();
                    document.getElementById('gps-btn').innerText = "ğŸ“";
                }, () => alert("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼"));
            };
        };
    </script>
</body>
</html>