<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åƒä»£ç”°åŒºã‚³ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒ—</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Leaflet JS (â˜…ã“ã“ã‚’è¿½åŠ ã—ã¦ä¿®æ­£â˜…) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // blue-500
                        secondary: '#64748b', // slate-500
                    }
                }
            }
        }
    </script>

    <style>
        /* Leafletã®ç«¶åˆå›é¿ & ã‚«ã‚¹ã‚¿ãƒ èª¿æ•´ */
        body { overscroll-behavior: none; }
        
        /* ãƒãƒ¼ã‚«ãƒ¼ã®å¹ãå‡ºã—ï¼ˆã—ã£ã½ä»˜ãï¼‰ */
        .marker-bubble {
            position: relative;
            background: white;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .marker-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }

        /* ãƒãƒ¼ã‚«ãƒ¼æœ¬ä½“ */
        .marker-circle {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* å¼·èª¿è¡¨ç¤ºã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .highlight-pin .marker-circle {
            transform: scale(1.2);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        .highlight-pin .marker-bubble {
            background-color: #eff6ff; /* blue-50 */
            color: #1d4ed8; /* blue-700 */
            border: 1px solid #bfdbfe; /* blue-200 */
        }
        .highlight-pin .marker-bubble::after {
            border-top-color: #eff6ff;
        }
        .highlight-pin { z-index: 9999 !important; }

        /* ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ”ãƒŠãƒ¼ */
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç´°ã */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-gray-50 text-slate-700 font-sans">

    <div id="container" class="flex flex-col md:flex-row h-full w-full relative">
        
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div id="sidebar" class="w-full md:w-80 bg-white flex flex-col shadow-xl z-20 h-1/2 md:h-full order-2 md:order-1 transition-all duration-300">
            
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
            <div id="login-section" class="p-4 border-b border-gray-100">
                <button id="login-btn" class="w-full bg-slate-800 text-white font-bold py-2 px-4 rounded-full hover:bg-slate-700 transition shadow-sm flex items-center justify-center gap-2">
                    <i class="fab fa-google"></i> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å§‹ã‚ã‚‹
                </button>
                
                <div id="user-info" class="hidden items-center gap-3">
                    <label class="relative cursor-pointer group">
                        <img id="user-icon" src="" class="w-10 h-10 rounded-full object-cover border-2 border-gray-100 group-hover:border-primary transition">
                        <div class="absolute bottom-0 right-0 bg-primary text-white rounded-full w-4 h-4 flex items-center justify-center text-[8px] border border-white">
                            <i class="fas fa-camera"></i>
                        </div>
                        <input type="file" id="avatar-upload-input" accept="image/*" class="hidden">
                    </label>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline gap-2">
                            <span id="user-name" class="font-bold text-sm truncate text-slate-800"></span>
                            <button id="edit-name-btn" class="text-xs text-slate-400 hover:text-primary"><i class="fas fa-pen"></i></button>
                        </div>
                    </div>
                    <button id="logout-btn" class="text-slate-400 hover:text-red-500 text-sm p-2"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
            <div id="filter-section" class="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
                <div class="relative">
                    <select id="sort-select" class="appearance-none bg-white border border-gray-200 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-100 cursor-pointer">
                        <option value="newest">ğŸ•’ æ–°ç€é †</option>
                        <option value="likes">â¤ï¸ äººæ°—é †</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                        <i class="fas fa-chevron-down text-[10px]"></i>
                    </div>
                </div>
                <span class="text-[10px] text-slate-400 font-medium bg-white px-2 py-1 rounded-md border border-gray-100">
                    2æ™‚é–“ä»¥å†…ã®æŠ•ç¨¿
                </span>
            </div>

            <!-- ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ -->
            <div id="sidebar-content" class="flex-1 overflow-y-auto">
                <ul id="comment-list" class="divide-y divide-gray-50">
                    <div id="loading-spinner" class="flex justify-center p-8">
                        <div class="loader ease-linear rounded-full border-2 border-gray-200 h-6 w-6"></div>
                    </div>
                </ul>
            </div>
        </div>

        <!-- åœ°å›³ã‚¨ãƒªã‚¢ -->
        <div id="mapid" class="flex-1 h-1/2 md:h-full bg-gray-100 relative order-1 md:order-2 z-10">
            <!-- PCç”¨ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ãƒœã‚¿ãƒ³ -->
            <button id="sidebar-toggle" onclick="toggleSidebar()" class="hidden md:flex absolute top-4 left-4 z-[1000] bg-white text-slate-600 hover:text-primary w-10 h-10 rounded-xl shadow-lg items-center justify-center transition hover:scale-105">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <!-- ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ -->
            <button id="gps-btn" class="absolute bottom-6 right-6 z-[1000] bg-slate-800 text-white w-12 h-12 rounded-full shadow-xl flex items-center justify-center text-lg hover:bg-slate-700 transition hover:scale-110 active:scale-95">
                <i class="fas fa-location-arrow"></i>
            </button>
        </div>
    </div>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold opacity-0 pointer-events-none transition-all duration-300 z-[9999] translate-y-4">
        é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        // =========================================================
        // ğŸ”¥ é‡è¦: è‡ªåˆ†ã® firebaseConfig ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
        // =========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyCZxC2imSus21qmrN4OelItvq9pyGJm0sE",
          authDomain: "chiyoda-map-sns.firebaseapp.com",
          projectId: "chiyoda-map-sns",
          storageBucket: "chiyoda-map-sns.firebasestorage.app",
          messagingSenderId: "140311034396",
          appId: "1:140311034396:web:eff090822e46f6d5787dd9"
        };
        // =========================================================

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
        function showToast(message, type = 'normal') {
            const toast = document.getElementById("toast");
            toast.innerHTML = type === 'success' ? `<i class="fas fa-check-circle mr-2 text-green-400"></i>${message}` : 
                              type === 'error' ? `<i class="fas fa-exclamation-circle mr-2 text-red-400"></i>${message}` : message;
            toast.classList.remove("opacity-0", "translate-y-4", "pointer-events-none");
            setTimeout(() => toast.classList.add("opacity-0", "translate-y-4", "pointer-events-none"), 3000);
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const btnIcon = document.querySelector('#sidebar-toggle i');
            
            if (sb.classList.contains('md:-ml-80')) {
                sb.classList.remove('md:-ml-80');
                btnIcon.className = 'fas fa-chevron-left';
            } else {
                sb.classList.add('md:-ml-80');
                btnIcon.className = 'fas fa-chevron-right';
            }
        }

        window.onload = function() {
            // Leafletã®èª­ã¿è¾¼ã¿ãƒã‚§ãƒƒã‚¯
            if (typeof L === 'undefined') { 
                alert('åœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚'); 
                return; 
            }
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(e=>{});

            var center = [35.685175, 139.752762];
            var map = L.map('mapid', { zoomControl: false }).setView(center, 14);
            L.control.zoom({ position: 'topright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' }).addTo(map);

            var markersMap = {};
            var currentPostsData = []; 
            var currentLocationMarker = null;
            var currentUser = null;
            var userProfile = { name: "", photo: "" };
            var unsubscribe = null;
            var selectedDocId = null;

            document.getElementById('login-btn').onclick = () => auth.signInWithPopup(provider).catch(e => showToast(e.message, 'error'));
            document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => showToast("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"));
            
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    await loadUserProfile(user);
                    document.getElementById('login-btn').classList.add('hidden');
                    document.getElementById('user-info').classList.remove('hidden');
                    document.getElementById('user-info').classList.add('flex');
                    updateProfileUI();
                } else {
                    document.getElementById('login-btn').classList.remove('hidden');
                    document.getElementById('user-info').classList.add('hidden');
                    document.getElementById('user-info').classList.remove('flex');
                    userProfile = { name: "", photo: "" };
                }
                setupDataListener();
            });

            async function loadUserProfile(user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    userProfile.name = data.handleName || user.displayName;
                    userProfile.photo = data.photoURL || user.photoURL;
                } else {
                    userProfile.name = user.displayName;
                    userProfile.photo = user.photoURL;
                    await db.collection('users').doc(user.uid).set({
                        handleName: userProfile.name, photoURL: userProfile.photo, updatedAt: new Date().toISOString()
                    });
                }
            }

            function updateProfileUI() {
                document.getElementById('user-name').textContent = userProfile.name;
                document.getElementById('user-icon').src = userProfile.photo;
            }

            document.getElementById('edit-name-btn').onclick = async function() {
                const newName = prompt("æ–°ã—ã„åå‰:", userProfile.name);
                if(newName && newName.trim()) {
                    await db.collection('users').doc(currentUser.uid).update({ handleName: newName });
                    userProfile.name = newName; updateProfileUI();
                    showToast("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ", 'success');
                }
            };

            document.getElementById('avatar-upload-input').onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 500 * 1024) { showToast("ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™", 'error'); return; }
                const reader = new FileReader();
                reader.onload = async function(evt) {
                    const base64 = evt.target.result;
                    try {
                        await db.collection('users').doc(currentUser.uid).update({ photoURL: base64 });
                        userProfile.photo = base64; updateProfileUI();
                        showToast("ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´ã—ã¾ã—ãŸ", 'success');
                    } catch(err) { showToast("æ›´æ–°å¤±æ•—", 'error'); }
                };
                reader.readAsDataURL(file);
            };

            function setupDataListener() {
                if(unsubscribe) unsubscribe();
                unsubscribe = db.collection("posts").onSnapshot((snapshot) => {
                    const spinner = document.getElementById('loading-spinner');
                    if (spinner) spinner.style.display = 'none';
                    
                    currentPostsData = [];
                    snapshot.forEach(doc => {
                        currentPostsData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const currentIds = currentPostsData.map(p => p.id);
                    Object.keys(markersMap).forEach(id => {
                        if (!currentIds.includes(id)) {
                            map.removeLayer(markersMap[id]);
                            delete markersMap[id];
                        }
                    });

                    refreshUI(); 
                });
            }

            function selectPost(docId) {
                selectedDocId = docId;
                Object.keys(markersMap).forEach(id => {
                    const marker = markersMap[id];
                    const elem = marker.getElement();
                    if (elem) {
                        if (id === docId) {
                            elem.classList.add('highlight-pin');
                            marker.setZIndexOffset(100000);
                        } else {
                            elem.classList.remove('highlight-pin');
                            const data = currentPostsData.find(p => p.id === id);
                            const likeCount = data && data.likedBy ? data.likedBy.length : 0;
                            marker.setZIndexOffset(likeCount * 100);
                        }
                    }
                });

                const listItem = document.getElementById('post-' + docId);
                if (listItem) {
                    document.querySelectorAll('.comment-item').forEach(el => el.classList.remove('bg-blue-50', 'border-l-4', 'border-primary'));
                    listItem.classList.add('bg-blue-50', 'border-l-4', 'border-primary');
                    listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                if (markersMap[docId]) {
                    map.panTo(markersMap[docId].getLatLng());
                }
            }

            function refreshUI() {
                const sortMode = document.getElementById('sort-select').value;
                const list = document.getElementById('comment-list');
                list.innerHTML = ""; 

                const now = new Date();
                const limitMs = 2 * 60 * 60 * 1000; 

                let filteredData = currentPostsData.filter(item => {
                    const date = new Date(item.date);
                    const diffMs = now - date;
                    return diffMs < limitMs;
                });

                filteredData.sort((a, b) => {
                    if (sortMode === 'newest') return new Date(b.date) - new Date(a.date);
                    else if (sortMode === 'likes') {
                        const likeA = a.likedBy ? a.likedBy.length : 0;
                        const likeB = b.likedBy ? b.likedBy.length : 0;
                        if (likeB !== likeA) return likeB - likeA;
                        return new Date(b.date) - new Date(a.date);
                    }
                });

                filteredData.forEach(data => {
                    const docId = data.id;
                    const likeCount = data.likedBy ? data.likedBy.length : 0;

                    if (!markersMap[docId]) {
                        const icon = createCustomIcon(data.text, data.image, data.category);
                        const marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                        marker.on('click', (e) => { L.DomEvent.stopPropagation(e); selectPost(docId); });
                        markersMap[docId] = marker;
                    } else {
                        const marker = markersMap[docId];
                        marker.setIcon(createCustomIcon(data.text, data.image, data.category));
                    }

                    const marker = markersMap[docId];
                    if (docId === selectedDocId) {
                        marker.setZIndexOffset(100000);
                        setTimeout(() => { if(marker.getElement()) marker.getElement().classList.add('highlight-pin'); }, 0);
                    } else {
                        marker.setZIndexOffset(likeCount * 100);
                        if(marker.getElement()) marker.getElement().classList.remove('highlight-pin');
                    }

                    addSidebarItem(docId, data);
                });
            }

            document.getElementById('sort-select').onchange = refreshUI;

            map.on('click', function(e) {
                if(e.originalEvent.target.closest('button')) return;
                selectedDocId = null;
                document.querySelectorAll('.highlight-pin').forEach(el => el.classList.remove('highlight-pin'));
                document.querySelectorAll('.comment-item').forEach(el => el.classList.remove('bg-blue-50', 'border-l-4', 'border-primary'));
                
                const container = document.createElement('div');
                container.className = 'w-64 text-center p-2';
                
                if (!currentUser) {
                    container.innerHTML = `<div class="text-xs text-red-500 mb-2 font-bold">æŠ•ç¨¿ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>`;
                } else {
                    container.innerHTML = `
                        <div class="text-xs text-slate-500 mb-3 text-left font-medium"><b>${userProfile.name}</b> ã¨ã—ã¦æŠ•ç¨¿</div>
                        <div class="flex justify-between mb-3 px-1">
                            <label class="cursor-pointer p-1 rounded-full hover:bg-orange-50 transition border-2 border-transparent hover:border-orange-200 has-checked:bg-orange-100 has-checked:border-orange-400">
                                <input type="radio" name="cat" value="gourmet" class="hidden">
                                <span class="text-xl">ğŸ´</span>
                            </label>
                            <label class="cursor-pointer p-1 rounded-full hover:bg-green-50 transition border-2 border-transparent hover:border-green-200 has-checked:bg-green-100 has-checked:border-green-400">
                                <input type="radio" name="cat" value="view" class="hidden">
                                <span class="text-xl">ğŸ—»</span>
                            </label>
                            <label class="cursor-pointer p-1 rounded-full hover:bg-purple-50 transition border-2 border-transparent hover:border-purple-200 has-checked:bg-purple-100 has-checked:border-purple-400">
                                <input type="radio" name="cat" value="event" class="hidden">
                                <span class="text-xl">ğŸ‰</span>
                            </label>
                            <label class="cursor-pointer p-1 rounded-full hover:bg-blue-50 transition border-2 border-transparent hover:border-blue-200 has-checked:bg-blue-100 has-checked:border-blue-400">
                                <input type="radio" name="cat" value="other" class="hidden" checked>
                                <span class="text-xl">ğŸ’¬</span>
                            </label>
                        </div>
                        <style>.has-checked:has(:checked) { transform: scale(1.1); }</style>
                        <input type="text" id="post-text" class="w-full p-2 mb-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ...">
                        <div class="flex justify-between items-center">
                            <label for="post-file-input" class="cursor-pointer text-slate-400 hover:text-primary text-xl p-2 transition" id="file-label"><i class="fas fa-camera"></i></label>
                            <input type="file" id="post-file-input" accept="image/*" class="hidden">
                            <button id="submit-post" class="bg-primary text-white text-xs font-bold py-2 px-6 rounded-full shadow-md hover:bg-blue-600 transition active:scale-95">æŠ•ç¨¿</button>
                        </div>
                    `;
                }
                L.popup().setLatLng(e.latlng).setContent(container).openOn(map);

                setTimeout(() => {
                    if(!currentUser) return;
                    const fileInput = document.getElementById('post-file-input');
                    const label = document.getElementById('file-label');
                    const btn = document.getElementById('submit-post');
                    
                    fileInput.onchange = () => {
                        if(fileInput.files.length > 0) {
                            label.classList.remove('text-slate-400');
                            label.classList.add('text-green-500');
                        } else {
                            label.classList.add('text-slate-400');
                            label.classList.remove('text-green-500');
                        }
                    };

                    btn.onclick = () => {
                        const text = document.getElementById('post-text').value;
                        const catInput = document.querySelector('input[name="cat"]:checked');
                        const category = catInput ? catInput.value : 'other';
                        
                        if(!text) return showToast("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", 'error');
                        
                        const file = fileInput.files[0];
                        if (file) {
                            if (file.size > 800 * 1024) return showToast("ç”»åƒã‚µã‚¤ã‚ºéå¤§", 'error');
                            const reader = new FileReader();
                            reader.onload = (evt) => submitPost(e.latlng, text, evt.target.result, category);
                            reader.readAsDataURL(file);
                        } else {
                            submitPost(e.latlng, text, null, category);
                        }
                    };
                }, 100);
            });

            function submitPost(latlng, text, imageData, category) {
                db.collection("posts").add({
                    lat: latlng.lat, lng: latlng.lng, text: text, image: imageData, category: category,
                    date: new Date().toISOString(), uid: currentUser.uid,
                    authorName: userProfile.name, authorPhoto: userProfile.photo, likedBy: []
                }).then(() => {
                    map.closePopup();
                    showToast("æŠ•ç¨¿ã—ã¾ã—ãŸï¼", 'success');
                }).catch(e => showToast(e.message, 'error'));
            }

            function addSidebarItem(docId, data) {
                const list = document.getElementById('comment-list');
                const li = document.createElement('li');
                
                // Tailwind classes
                li.className = 'group flex items-start p-4 hover:bg-gray-50 cursor-pointer transition border-l-4 border-transparent';
                li.id = 'post-' + docId;
                
                if (docId === selectedDocId) li.classList.add('bg-blue-50', 'border-primary');
                
                // ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼
                const catColors = { gourmet: 'border-orange-400', view: 'border-green-500', event: 'border-purple-500', other: 'border-blue-500' };
                // é¸æŠä¸­ã§ãªã„å ´åˆã®ã¿ã‚«ãƒ†ã‚´ãƒªè‰²ã‚’é©ç”¨
                if (docId !== selectedDocId && data.category) li.classList.add(catColors[data.category] || 'border-blue-500');

                const avatar = document.createElement('img');
                avatar.className = 'w-10 h-10 rounded-full mr-3 object-cover bg-gray-200 flex-shrink-0 border border-gray-100';
                avatar.src = data.authorPhoto || 'https://placehold.co/40';
                li.appendChild(avatar);

                const body = document.createElement('div');
                body.className = 'flex-1 min-w-0 mr-3';
                
                const header = document.createElement('div');
                header.className = 'flex items-center gap-2 mb-1';
                const timeStr = new Date(data.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                header.innerHTML = `<span class="font-bold text-sm text-slate-800 truncate">${data.authorName}</span> <span class="text-xs text-slate-400">${timeStr}</span>`;
                body.appendChild(header);

                const textDiv = document.createElement('div');
                textDiv.className = 'text-sm text-slate-600 leading-snug break-words';
                textDiv.innerHTML = formatTextWithHashtags(data.text);
                body.appendChild(textDiv);

                const footer = document.createElement('div');
                footer.className = 'flex items-center gap-4 mt-2';
                
                const likeBtn = document.createElement('button');
                likeBtn.className = 'flex items-center gap-1 text-xs text-slate-400 hover:text-pink-500 transition group/like';
                const likeCount = data.likedBy ? data.likedBy.length : 0;
                const isLiked = currentUser && data.likedBy && data.likedBy.includes(currentUser.uid);
                
                likeBtn.innerHTML = `<i class="${isLiked ? 'fas' : 'far'} fa-heart text-sm ${isLiked ? 'text-pink-500' : ''}"></i> <span>${likeCount || ''}</span>`;

                likeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(!currentUser) return showToast("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„", 'error');
                    const postRef = db.collection("posts").doc(docId);
                    if (isLiked) {
                        postRef.update({ likedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                    } else {
                        postRef.update({ likedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                    }
                };
                footer.appendChild(likeBtn);

                // ã‚·ã‚§ã‚¢
                const shareBtn = document.createElement('button');
                shareBtn.className = 'text-slate-400 hover:text-blue-500 transition text-xs';
                shareBtn.innerHTML = '<i class="fas fa-share-alt"></i>';
                shareBtn.onclick = (e) => {
                    e.stopPropagation();
                    const shareText = `ã€Œ${data.text}ã€ #åƒä»£ç”°åŒºãƒãƒƒãƒ—SNS`;
                    if (navigator.share) navigator.share({ title: 'åƒä»£ç”°åŒºãƒãƒƒãƒ—', text: shareText, url: window.location.href }).catch(()=>{});
                    else window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
                };
                footer.appendChild(shareBtn);

                if (currentUser && data.uid === currentUser.uid) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'text-slate-300 hover:text-red-500 transition text-xs ml-auto opacity-0 group-hover:opacity-100';
                    delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                            db.collection("posts").doc(docId).delete().then(()=>showToast("å‰Šé™¤ã—ã¾ã—ãŸ"));
                        }
                    };
                    footer.appendChild(delBtn);
                }
                
                body.appendChild(footer);
                li.appendChild(body);

                if (data.image) {
                    const thumb = document.createElement('img');
                    thumb.className = 'w-16 h-16 rounded-lg object-cover border border-gray-100 bg-gray-50 flex-shrink-0';
                    thumb.src = data.image;
                    li.appendChild(thumb);
                }

                li.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    selectPost(docId);
                };
                list.appendChild(li);
            }

            function createCustomIcon(text, image, category) {
                if(text.length > 10) text = text.substring(0, 10) + "...";
                
                // Tailwind classes inside HTML string
                let circleClass = 'w-5 h-5 rounded-full border-2 border-white shadow-md relative z-10 transition-all duration-300';
                let circleStyle = '';
                
                // ã‚«ãƒ†ã‚´ãƒªè‰² (Tailwind colors manually applied for inline style fallback)
                const colors = { gourmet: '#fb923c', view: '#4ade80', event: '#c084fc', other: '#3b82f6' };
                const color = colors[category] || colors.other;

                if (image) {
                    circleClass = 'w-11 h-11 rounded-full border-2 border-white bg-white shadow-md relative z-10 transition-all duration-300';
                    circleStyle = `background-image: url('${image}'); background-size: cover; background-position: center;`;
                } else {
                    circleStyle = `background: linear-gradient(135deg, ${color}, #333); box-shadow: inset 0 2px 4px rgba(255,255,255,0.4);`;
                }

                const html = `
                    <div class="marker-container flex flex-col items-center justify-end w-[120px] relative overflow-visible drop-shadow-sm group">
                        <div class="marker-bubble bg-white rounded-full px-3 py-1.5 text-[11px] font-bold text-slate-700 whitespace-nowrap shadow-sm mb-1.5 border border-gray-100 max-w-[140px] overflow-hidden text-ellipsis text-center relative">
                            ${text}
                        </div>
                        <div class="${circleClass}" style="${circleStyle}"></div>
                    </div>`;
                
                return L.divIcon({ html: html, className: '', iconSize: [120, 70], iconAnchor: [60, 65] });
            }

            function formatTextWithHashtags(text) { 
                return text ? text.replace(/(#\S+)/g, '<span class="text-primary font-medium mr-1">$1</span>') : ""; 
            }

            document.getElementById('gps-btn').onclick = function() {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(pos => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(latlng, 16);
                    if (currentLocationMarker) currentLocationMarker.setLatLng(latlng);
                    else {
                        currentLocationMarker = L.circleMarker(latlng, { radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 3, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                    }
                    currentLocationMarker.bindPopup("ç¾åœ¨åœ°").openPopup();
                });
            };
        };
    </script>
</body>
</html>